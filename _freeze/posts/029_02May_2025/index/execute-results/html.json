{
  "hash": "507161c5cf3414abbb93c760d01fc9d9",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Model Prediction/Visualisation <br> 3. Non-Linear Functional Forms\"\ndate: 2025-05-02\ncategories: [code, concept, modelling, visualisation]\n#image: \"images/plot.png\"\ndescription: \"Relaxing the linearity assumption does not make prediction/visualisation any more difficult.\"\n---\n\n\nYou'll be glad to know this is going to be a relatively short post. In fact, in discussing aspects of model prediction and visualisation, the non-linear functional form is almost not worthy of a separate post in itself. BUT, I'm going to walk you through an example anyway - mainly to highlight that the process is no more difficult, nor different, to that of predicting and visualising the linear relationship.\n\nTo illustrate this, we'll again use the `birthwt` dataset. If you recall from the first post in this series, when we considered the modelling of birthweight as a function of maternal age (and later, sex), we made the somewhat unrealistic assumption that maternal age was linearly associated with birthweight. With this constraint in place, the model suggested to us that increasing maternal age was associated with increasing birthweight. At the time I suggested this was biologically implausible and guessed that the association would be more of an inverted U-shape - i.e. birthweight increasing with maternal age to a certain point and then decreasing thereafter.\n\nSo, let's relax the assumption of linearity by including a restricted cubic spline term on maternal age and see what the simplest model with that as the sole predictor shows.\n\n::: callout-note\nNote that to better capture potential non-linearity, I have increased the 'resolution' of maternal age when creating the new data grid. I originally used `5` year intervals which was more than enough when we assumed the relationship was linear, but have now amended that to `1` year intervals.\n:::\n\nOur model then becomes:\n\n`mod <-  lm(bwt ~ ns(age, 3), data = birthwt)`\n\nAnd the visualisation of the model prediction is:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(splines)\ndata(birthwt, package = \"MASS\")\n# Model\nmod <-  lm(bwt ~ ns(age, 3), data = birthwt)\n# Create new data\nnewdf <-  expand.grid(age = seq(15, 45, by = 1))\n# Predict\nnewdf <-  newdf |> \n  mutate(pred = predict(mod, newdata = newdf))\n# Visualise\nggplot(data = newdf, aes(x = age, y = pred)) +\n  geom_line(linewidth = 1) +\n  geom_point(data = birthwt, aes(x = age, y = bwt)) +\n  xlab(\"Maternal Age\") + ylab(\"Predicted Birthweight\") +\n  scale_y_continuous(limits = c(0, 5000), breaks = seq(0, 5000, by = 1000)) +\n  theme_bw(base_size = 20) +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-1-1.png){width=1152}\n:::\n:::\n\n\nOk, so clearly there's more to this relationship than I had anticipated, but we already have more information than when we modelled the association assuming it was linear. Based on this prediction, birthweight remains relatively stable until the mother's age approaches `30` years, then increases thereafter. This still seems somewhat counter-intuitive to my mind, and in fact we may have good reason for not paying too much attention to the model prediction at older maternal ages. It turns out that only `20` out of `189` (i.e \\~ `10%` of mothers) are older than `30` years - and only `1` mother is older than `40` years. In addition, that single data point appears, on cursory examination, to exert considerable influence on the model fit.\n\nWhat happens if we refit the model without that observation?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(splines)\ndata(birthwt, package = \"MASS\")\n# Model\nmod <-  lm(bwt ~ ns(age, 3), data = subset(birthwt, age < 40))\n# Create new data\nnewdf <-  expand.grid(age = seq(15, 40, by = 1))\n# Predict\nnewdf <-  newdf |> \n  mutate(pred = predict(mod, newdata = newdf))\n# Visualise\nggplot(data = newdf, aes(x = age, y = pred)) +\n  geom_line(linewidth = 1) +\n  geom_point(data = birthwt, aes(x = age, y = bwt)) +\n  xlab(\"Maternal Age\") + ylab(\"Predicted Birthweight\") +\n  scale_y_continuous(limits = c(0, 5000), breaks = seq(0, 5000, by = 1000)) +\n  theme_bw(base_size = 20) +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=1152}\n:::\n:::\n\n\nThis appears a little more sensible than with the inclusion of the last data point, so we'll leave that observation out of all further calculations. Now let's also consider adjusting the prediction for potentially confounding factors that could be distorting the relationship as it currently stands. We'll start by first considering maternal smoking.\n\nThe association between maternal age and birthweight adjusted for maternal smoking can be visualised as:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Relabel smoking\nbirthwt$smoke <-  factor(birthwt$smoke, levels = c(0,1), labels = c(\"No\", \"Yes\"))\n# Model\nmod2 <-  lm(bwt ~ ns(age, 3) * smoke, data = subset(birthwt, age < 40))\n# Create new data\nnewdf <-  expand.grid(age = seq(15, 40, by = 1),\n                      smoke = levels(birthwt$smoke))\n# Predict\nnewdf <-  newdf |>\n  mutate(pred = predict(mod2, newdata = newdf))\n# Visualise\nggplot(data = newdf, aes(x = age, y = pred, color = smoke)) +\n  geom_line(linewidth = 1) +\n  geom_point(data = birthwt, aes(x = age, y = bwt)) +\n  xlab(\"Maternal Age\") + ylab(\"Predicted Birthweight\") + labs(color = \"Smoking Status\") +\n  scale_y_continuous(limits = c(0, 5000), breaks = seq(0, 5000, by = 1000)) +\n  theme_bw(base_size = 20) +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=1152}\n:::\n:::\n\n\nNow we can see that amongst smokers, birthweight declines with maternal age. However, we still observe that same oddly increasing profile of birthweight with maternal age amongst the non-smokers. Perhaps other factors are also at play? Let's just adjust for the full complement as we did in the last post (at least that we can visualise).\n\nThus, the association between maternal age and birthweight adjusted for maternal smoking, history of hypertension, race and uterine irritability, can be visualised as:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Relabel history of hypertension\nbirthwt$ht <-  factor(birthwt$ht, levels = c(0, 1), labels = c(\"No\", \"Yes\"))\nbirthwt$race <-  factor(birthwt$race, levels = c(1,2,3), labels = c(\"White\", \"Black\", \"Other\"))\nbirthwt$ui <-  factor(birthwt$ui, levels = c(0, 1), labels = c(\"No\", \"Yes\"))\n# Model\nmod3 <-  lm(bwt ~ ns(age,3) * smoke * race * ui * ht, data = subset(birthwt, age < 40))\n# Create new data\nnewdf <-  expand.grid(age = seq(15, 40, by = 1),\n                      smoke = levels(birthwt$smoke),\n                      race = levels(birthwt$race),\n                      ui = levels(birthwt$ui),\n                      ht = levels(birthwt$ht))\n# Create labels for plotting race\nlabel_race <- c(\"Race: White\", \"Race: Black\", \"Race: Other\")\nnames(label_race) <- c(\"White\", \"Black\", \"Other\")\n# Create labels for plotting ui\nlabel_ui <- c(\"Uterine Irritability: No\", \"Uterine Irritability: Yes\")\nnames(label_ui) <- c(\"No\", \"Yes\")\n# Predict\nnewdf <-  newdf |> \n  mutate(pred = predict(mod3, newdata = newdf))\n# Visualise\nggplot(data = newdf, aes(x = age, y = pred, group = interaction(smoke, ht), color = smoke, linetype = ht)) +\n  geom_line(linewidth = 1) +\n  geom_point(data = birthwt, aes(x = age, y = bwt)) +\n  xlab(\"Maternal Age\") + ylab(\"Predicted Birthweight\") + labs(color = \"Smoking Status\", linetype = \"History of Hypertension\") +\n  scale_y_continuous(limits = c(0, 5000), breaks = seq(0, 5000, by = 1000)) +\n  facet_grid(ui ~ race, labeller = labeller(race = label_race, ui = label_ui)) +\n  theme_bw(base_size = 20) +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=1152}\n:::\n:::\n\n\nWe're now seeing that the predictions further depend on the factors adjusted for. I am not going to attempt to explain any of this - my feeling is that there probably isn't enough data at older maternal ages to come to any firm conclusions about the nature of the true relationship. Furthermore, this is NOT a good model - there is not enough data to support the estimation of all the parameters involved when you interact a spline term with multiple covariates. But that's ok - ensuring model validity wasn't really the point of this post. Instead it was to show you the simplicity of predicting and visualising non-linear functional forms. And I hope that I have managed to do that.\n\nUntil next time...\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}