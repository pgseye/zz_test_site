<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-07-25">
<meta name="description" content="The hazards of misunderstanding the hazard ratio.">

<title>Test Site 2 - Are your Hazards Proportional? - What to do when it just ain’t so (Part 2)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Test Site 2</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">All Posts</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#adjust-your-model-specification" id="toc-adjust-your-model-specification" class="nav-link active" data-scroll-target="#adjust-your-model-specification"><span class="header-section-number">1</span> Adjust Your Model Specification</a></li>
  <li><a href="#use-strata" id="toc-use-strata" class="nav-link" data-scroll-target="#use-strata"><span class="header-section-number">2</span> Use Strata</a></li>
  <li><a href="#incorporate-non-proportionality-into-the-model" id="toc-incorporate-non-proportionality-into-the-model" class="nav-link" data-scroll-target="#incorporate-non-proportionality-into-the-model"><span class="header-section-number">3</span> Incorporate Non-Proportionality into the Model</a>
  <ul>
  <li><a href="#step-functions" id="toc-step-functions" class="nav-link" data-scroll-target="#step-functions"><span class="header-section-number">3.1</span> Step functions</a></li>
  <li><a href="#continuous-time-dependent-coefficients" id="toc-continuous-time-dependent-coefficients" class="nav-link" data-scroll-target="#continuous-time-dependent-coefficients"><span class="header-section-number">3.2</span> Continuous time-dependent coefficients</a>
  <ul class="collapse">
  <li><a href="#plot-time-varying-hr" id="toc-plot-time-varying-hr" class="nav-link" data-scroll-target="#plot-time-varying-hr"><span class="header-section-number">3.2.1</span> Plot time-varying HR</a></li>
  <li><a href="#estimate-hr-at-times-of-interest" id="toc-estimate-hr-at-times-of-interest" class="nav-link" data-scroll-target="#estimate-hr-at-times-of-interest"><span class="header-section-number">3.2.2</span> Estimate HR at times of interest</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#use-a-different-type-of-model" id="toc-use-a-different-type-of-model" class="nav-link" data-scroll-target="#use-a-different-type-of-model"><span class="header-section-number">4</span> Use a Different Type of Model</a>
  <ul>
  <li><a href="#accelerated-failure-time-model" id="toc-accelerated-failure-time-model" class="nav-link" data-scroll-target="#accelerated-failure-time-model"><span class="header-section-number">4.1</span> Accelerated failure time model</a></li>
  <li><a href="#flexible-parametric-royston-parmar-survival-model" id="toc-flexible-parametric-royston-parmar-survival-model" class="nav-link" data-scroll-target="#flexible-parametric-royston-parmar-survival-model"><span class="header-section-number">4.2</span> Flexible parametric (Royston-Parmar) survival model</a></li>
  </ul></li>
  <li><a href="#wrap-up" id="toc-wrap-up" class="nav-link" data-scroll-target="#wrap-up"><span class="header-section-number">5</span> Wrap-Up</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Are your Hazards Proportional? - What to do when it just ain’t so (Part 2)</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">code</div>
    <div class="quarto-category">concept</div>
    <div class="quarto-category">modelling</div>
    <div class="quarto-category">visualisation</div>
  </div>
  </div>

<div>
  <div class="description">
    The hazards of misunderstanding the hazard ratio.
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 25, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Welcome back to Stats Tips after a brief mid-year break.</p>
<p>In the last post we discussed some approaches to the diagnosis of non-proportional hazards for a covariate in our Cox model.</p>
<p>And the big question I’m sure you’re chomping at the bit to ask is “Well, what can we do about it?”</p>
<p>Ok, relax… there are in fact several things we can do. Today we are going to consider the remediation actions we can take when we are faced with this issue in our day-to-day work. To get us started and to introduce the concepts to you, I’ve broken those actions down broadly into four groups:</p>
<ol type="1">
<li><p>Model specification adjustments.</p></li>
<li><p>Use strata (categorical variables only).</p></li>
<li><p>Incorporate non-proportionality into the model (time-dependent coefficients).</p>
<ul>
<li><p>Step functions (different HR’s over different time intervals).</p></li>
<li><p>Continuous time-dependent coefficients (smoothed HR over time).</p></li>
</ul></li>
<li><p>Use a different type of model.</p>
<ul>
<li><p>Accelerated failure time model.</p></li>
<li><p>Flexible parametric (Royston-Parmar) survival model.</p></li>
</ul></li>
</ol>
<p>In providing examples of how we might implement each of these in <code>R</code> we will return to the <code>veteran</code> dataset that we used in the last post, so get that ready using the code below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(survminer)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(gtsummary)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co"># Load veteran data from survival package</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>vdata1 <span class="ot">&lt;-</span>  veteran</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co"># Make treatment variable equal to 0,1 instead of 1,2 (not necessary, but I just like to work with the former)</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>vdata1<span class="sc">$</span>trt <span class="ot">&lt;-</span>  <span class="fu">as.numeric</span>(vdata1<span class="sc">$</span>trt) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co"># Create id variable and organise columns</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>vdata1<span class="sc">$</span>id <span class="ot">&lt;-</span>  <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(vdata1)[<span class="dv">1</span>])</span>
<span id="cb1-12"><a href="#cb1-12"></a>vdata1 <span class="ot">&lt;-</span>  vdata1 <span class="sc">|&gt;</span> </span>
<span id="cb1-13"><a href="#cb1-13"></a>  <span class="fu">select</span>(id, time, status, trt, age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s talk about these ideas in more detail now.</p>
<section id="adjust-your-model-specification" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Adjust Your Model Specification</h1>
<p>This is something you can explore in your model before you take any of the subsequent actions that I describe. In fact, this is not really doing anything special at all in the treatment of non-proportional hazards. All you are doing here is attempting to optimise your model specification, and that’s an ideal that we should aim to achieve in every model we make.</p>
<p>It may not be immediately intuitive, but tests for proportional hazards (PH) come after the model coefficients for the covariates have been estimated. If there is an error in the model for how the covariates are specified that can also lead to a failure of a PH test - in other words, the power of the test to detect non-proportionality is contingent on the correct specification of the model.</p>
<p>So what do I mean with all this talk of ‘model specification’? Well, in the current context there are three things you can consider doing to optimise your model and facilitate PH testing success:</p>
<ol type="1">
<li><p>Check the functional form of your continuous covariates.</p></li>
<li><p>Check you haven’t omitted any necessary interactions.</p></li>
<li><p>Check you haven’t omitted any important variables.</p></li>
</ol>
<p>The first point is simply stating that when you enter a continuous covariate in a model, the model assumes the relationship of that covariate with the outcome of interest (i.e.&nbsp;its functional form) is linear in nature. This can often be an unrealistic assumption, but it is one that is easily checked and fixed by allowing for potential non-linearity with the inclusion of a restricted cubic spline term on your covariate (<a href="https://msni-stats-tips.netlify.app/posts/009_05apr_2024/">see here)</a>.</p>
<p>The second point is also not difficult to assess in your model. Consider whether there are any potential moderating effects of covariates on the association between any other covariate and the outcome. Test this with the inclusion of an interaction term.</p>
<p>Unfortunately, the third point is more difficult to do anything about as with observational data we typically don’t know what we don’t know. And if we do know another variable would be of value to incorporate in our model, we simply may not have any information on it. So you will be a bit more hamstrung here.</p>
<p>If you recall from the last post, the model fit exploring the association between <code>trt</code> and <code>age</code> and the risk of death, and the resulting GOF PH test from that model was:</p>
<p><code>vfit1 &lt;- coxph(Surv(time, status) ~ trt + age, vdata1)</code></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Fit basic model with treatment and age as the only predictors</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>vfit1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt <span class="sc">+</span> age, vdata1)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="fu">tbl_regression</span>(vfit1, <span class="at">exp =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fidcdgzrul" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#fidcdgzrul table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#fidcdgzrul thead, #fidcdgzrul tbody, #fidcdgzrul tfoot, #fidcdgzrul tr, #fidcdgzrul td, #fidcdgzrul th {
  border-style: none;
}

#fidcdgzrul p {
  margin: 0;
  padding: 0;
}

#fidcdgzrul .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#fidcdgzrul .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#fidcdgzrul .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#fidcdgzrul .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#fidcdgzrul .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#fidcdgzrul .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#fidcdgzrul .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#fidcdgzrul .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#fidcdgzrul .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#fidcdgzrul .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#fidcdgzrul .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#fidcdgzrul .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#fidcdgzrul .gt_spanner_row {
  border-bottom-style: hidden;
}

#fidcdgzrul .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#fidcdgzrul .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#fidcdgzrul .gt_from_md > :first-child {
  margin-top: 0;
}

#fidcdgzrul .gt_from_md > :last-child {
  margin-bottom: 0;
}

#fidcdgzrul .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#fidcdgzrul .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#fidcdgzrul .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#fidcdgzrul .gt_row_group_first td {
  border-top-width: 2px;
}

#fidcdgzrul .gt_row_group_first th {
  border-top-width: 2px;
}

#fidcdgzrul .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#fidcdgzrul .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#fidcdgzrul .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#fidcdgzrul .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#fidcdgzrul .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#fidcdgzrul .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#fidcdgzrul .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#fidcdgzrul .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#fidcdgzrul .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#fidcdgzrul .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#fidcdgzrul .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#fidcdgzrul .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#fidcdgzrul .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#fidcdgzrul .gt_left {
  text-align: left;
}

#fidcdgzrul .gt_center {
  text-align: center;
}

#fidcdgzrul .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#fidcdgzrul .gt_font_normal {
  font-weight: normal;
}

#fidcdgzrul .gt_font_bold {
  font-weight: bold;
}

#fidcdgzrul .gt_font_italic {
  font-style: italic;
}

#fidcdgzrul .gt_super {
  font-size: 65%;
}

#fidcdgzrul .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#fidcdgzrul .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#fidcdgzrul .gt_indent_1 {
  text-indent: 5px;
}

#fidcdgzrul .gt_indent_2 {
  text-indent: 10px;
}

#fidcdgzrul .gt_indent_3 {
  text-indent: 15px;
}

#fidcdgzrul .gt_indent_4 {
  text-indent: 20px;
}

#fidcdgzrul .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="<strong>Characteristic</strong>" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col"><strong>Characteristic</strong></th>
<th id="<strong>HR</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>HR</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
<th id="<strong>95% CI</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>95% CI</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
<th id="<strong>p-value</strong>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>p-value</strong></th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="label">trt</td>
<td class="gt_row gt_center" headers="estimate">1.00</td>
<td class="gt_row gt_center" headers="ci">0.70, 1.42</td>
<td class="gt_row gt_center" headers="p.value">&gt;0.9</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">age</td>
<td class="gt_row gt_center" headers="estimate">1.01</td>
<td class="gt_row gt_center" headers="ci">0.99, 1.03</td>
<td class="gt_row gt_center" headers="p.value">0.4</td>
</tr>
</tbody><tfoot class="gt_footnotes">
<tr class="odd">
<td colspan="4" class="gt_footnote"><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span> HR = Hazard Ratio, CI = Confidence Interval</td>
</tr>
</tfoot>

</table>

</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># Test Schoenfeld residuals</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>(sch_res <span class="ot">&lt;-</span>  <span class="fu">cox.zph</span>(vfit1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       chisq df     p
trt     3.67  1 0.055
age     1.68  1 0.195
GLOBAL  6.20  2 0.045</code></pre>
</div>
</div>
<p>Now, what happens if we include a spline term on age?</p>
<p><code>vfit2 &lt;- coxph(Surv(time, status) ~ trt + splines::ns(age,3), vdata1)</code></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># Refit model with spline on age</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>vfit2 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt <span class="sc">+</span> splines<span class="sc">::</span><span class="fu">ns</span>(age,<span class="dv">3</span>), vdata1)</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="fu">tbl_regression</span>(vfit2, <span class="at">exp =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="zmfgughykj" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#zmfgughykj table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#zmfgughykj thead, #zmfgughykj tbody, #zmfgughykj tfoot, #zmfgughykj tr, #zmfgughykj td, #zmfgughykj th {
  border-style: none;
}

#zmfgughykj p {
  margin: 0;
  padding: 0;
}

#zmfgughykj .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#zmfgughykj .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#zmfgughykj .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#zmfgughykj .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#zmfgughykj .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zmfgughykj .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zmfgughykj .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zmfgughykj .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#zmfgughykj .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#zmfgughykj .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#zmfgughykj .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#zmfgughykj .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#zmfgughykj .gt_spanner_row {
  border-bottom-style: hidden;
}

#zmfgughykj .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#zmfgughykj .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#zmfgughykj .gt_from_md > :first-child {
  margin-top: 0;
}

#zmfgughykj .gt_from_md > :last-child {
  margin-bottom: 0;
}

#zmfgughykj .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#zmfgughykj .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#zmfgughykj .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#zmfgughykj .gt_row_group_first td {
  border-top-width: 2px;
}

#zmfgughykj .gt_row_group_first th {
  border-top-width: 2px;
}

#zmfgughykj .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zmfgughykj .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#zmfgughykj .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#zmfgughykj .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zmfgughykj .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zmfgughykj .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#zmfgughykj .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#zmfgughykj .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#zmfgughykj .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zmfgughykj .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zmfgughykj .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zmfgughykj .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zmfgughykj .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zmfgughykj .gt_left {
  text-align: left;
}

#zmfgughykj .gt_center {
  text-align: center;
}

#zmfgughykj .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#zmfgughykj .gt_font_normal {
  font-weight: normal;
}

#zmfgughykj .gt_font_bold {
  font-weight: bold;
}

#zmfgughykj .gt_font_italic {
  font-style: italic;
}

#zmfgughykj .gt_super {
  font-size: 65%;
}

#zmfgughykj .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#zmfgughykj .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#zmfgughykj .gt_indent_1 {
  text-indent: 5px;
}

#zmfgughykj .gt_indent_2 {
  text-indent: 10px;
}

#zmfgughykj .gt_indent_3 {
  text-indent: 15px;
}

#zmfgughykj .gt_indent_4 {
  text-indent: 20px;
}

#zmfgughykj .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header gt_col_headings">
<th id="<strong>Characteristic</strong>" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col"><strong>Characteristic</strong></th>
<th id="<strong>HR</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>HR</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
<th id="<strong>95% CI</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>95% CI</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
<th id="<strong>p-value</strong>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>p-value</strong></th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="label">trt</td>
<td class="gt_row gt_center" headers="estimate">1.09</td>
<td class="gt_row gt_center" headers="ci">0.76, 1.57</td>
<td class="gt_row gt_center" headers="p.value">0.6</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">splines::ns(age, 3)</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="ci"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;splines::ns(age, 3)1</td>
<td class="gt_row gt_center" headers="estimate">1.04</td>
<td class="gt_row gt_center" headers="ci">0.54, 2.02</td>
<td class="gt_row gt_center" headers="p.value">&gt;0.9</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;splines::ns(age, 3)2</td>
<td class="gt_row gt_center" headers="estimate">0.23</td>
<td class="gt_row gt_center" headers="ci">0.03, 1.65</td>
<td class="gt_row gt_center" headers="p.value">0.14</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;splines::ns(age, 3)3</td>
<td class="gt_row gt_center" headers="estimate">2.50</td>
<td class="gt_row gt_center" headers="ci">0.73, 8.58</td>
<td class="gt_row gt_center" headers="p.value">0.14</td>
</tr>
</tbody><tfoot class="gt_footnotes">
<tr class="even">
<td colspan="4" class="gt_footnote"><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span> HR = Hazard Ratio, CI = Confidence Interval</td>
</tr>
</tfoot>

</table>

</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># Test Schoenfeld residuals</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>(sch_res <span class="ot">&lt;-</span>  <span class="fu">cox.zph</span>(vfit2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                    chisq df    p
trt                  2.56  1 0.11
splines::ns(age, 3)  4.55  3 0.21
GLOBAL               6.60  4 0.16</code></pre>
</div>
</div>
<p>Well there you go - we have already made things better! Unfortunately there is no free lunch and now that you have improved the test of PH by a functional form correction, you need to contend with the complexities involved with the interpretation of spline terms. As I outlined in my previous post on the use of splines, the coefficients are not directly interpretable and so the best option is always to plot your results. We can do that here for the HR for age with a little bit of help from the <code>emmeans</code> and <code>data.table</code> packages:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">library</span>(emmeans)</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="co"># Estimate hazard rate at yearly intervals</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>emm_df <span class="ot">&lt;-</span>  <span class="fu">emmeans</span>(vfit2, <span class="sc">~</span> age, <span class="at">at =</span> <span class="fu">list</span>(<span class="at">age =</span> <span class="fu">seq</span>(<span class="dv">30</span>, <span class="dv">80</span>, <span class="at">by =</span> <span class="dv">1</span>)), <span class="at">type =</span> <span class="st">"unlink"</span>)</span>
<span id="cb8-4"><a href="#cb8-4"></a>emm_df <span class="ot">&lt;-</span>  <span class="fu">data.frame</span>(emm_df)</span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="co"># Calculate HR at yearly intervals by dividing each successive pair of hazard rates</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="fu">library</span>(data.table)</span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="fu">setDT</span>(emm_df)[, pred_HR <span class="sc">:</span><span class="er">=</span> <span class="fu">c</span>(<span class="cn">NA</span>, response[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">/</span> response[<span class="sc">-</span>.N])]</span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="co"># Plot HR for age over range of age</span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="fu">ggplot</span>(emm_df, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> pred_HR, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb8-10"><a href="#cb8-10"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb8-11"><a href="#cb8-11"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.2</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.2</span>, <span class="at">by =</span> <span class="fl">0.25</span>)) <span class="sc">+</span></span>
<span id="cb8-13"><a href="#cb8-13"></a>  <span class="fu">xlab</span>(<span class="st">"Age"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Predicted HR"</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Predicted HR for Age (as a function of Age)"</span>) <span class="sc">+</span></span>
<span id="cb8-14"><a href="#cb8-14"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="use-strata" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Use Strata</h1>
<p>The next simplest approach to dealing with a PH violation is to stratify on the offending covariate in your model. This provides additional flexibility in allowing for proportional hazards <em>within</em> each stratum (i.e.&nbsp;level) of the covariate, but for that definitional reason, really only works with <em>categorical</em> variables. In this stratified Cox model, <strong>the regression coefficients are assumed to be the same in each stratum</strong>, but the <strong>baseline hazard functions may be completely different</strong>. And that is how the problem of non-proportionality is circumvented in using this method.</p>
<p>Within the <code>coxph()</code> model call it’s a simple case of specifying a <code>strata()</code> term. Let’s do that now for <code>trt</code>:</p>
<p><code>vfit3 &lt;- coxph(Surv(time, status) ~ trt + age + strata(trt), vdata1)</code></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>vfit3 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">strata</span>(trt), vdata1)</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="fu">tbl_regression</span>(vfit3, <span class="at">exp =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="yuaxvcplfa" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#yuaxvcplfa table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#yuaxvcplfa thead, #yuaxvcplfa tbody, #yuaxvcplfa tfoot, #yuaxvcplfa tr, #yuaxvcplfa td, #yuaxvcplfa th {
  border-style: none;
}

#yuaxvcplfa p {
  margin: 0;
  padding: 0;
}

#yuaxvcplfa .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#yuaxvcplfa .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#yuaxvcplfa .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#yuaxvcplfa .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#yuaxvcplfa .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#yuaxvcplfa .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#yuaxvcplfa .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#yuaxvcplfa .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#yuaxvcplfa .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#yuaxvcplfa .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#yuaxvcplfa .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#yuaxvcplfa .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#yuaxvcplfa .gt_spanner_row {
  border-bottom-style: hidden;
}

#yuaxvcplfa .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#yuaxvcplfa .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#yuaxvcplfa .gt_from_md > :first-child {
  margin-top: 0;
}

#yuaxvcplfa .gt_from_md > :last-child {
  margin-bottom: 0;
}

#yuaxvcplfa .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#yuaxvcplfa .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#yuaxvcplfa .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#yuaxvcplfa .gt_row_group_first td {
  border-top-width: 2px;
}

#yuaxvcplfa .gt_row_group_first th {
  border-top-width: 2px;
}

#yuaxvcplfa .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#yuaxvcplfa .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#yuaxvcplfa .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#yuaxvcplfa .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#yuaxvcplfa .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#yuaxvcplfa .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#yuaxvcplfa .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#yuaxvcplfa .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#yuaxvcplfa .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#yuaxvcplfa .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#yuaxvcplfa .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#yuaxvcplfa .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#yuaxvcplfa .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#yuaxvcplfa .gt_left {
  text-align: left;
}

#yuaxvcplfa .gt_center {
  text-align: center;
}

#yuaxvcplfa .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#yuaxvcplfa .gt_font_normal {
  font-weight: normal;
}

#yuaxvcplfa .gt_font_bold {
  font-weight: bold;
}

#yuaxvcplfa .gt_font_italic {
  font-style: italic;
}

#yuaxvcplfa .gt_super {
  font-size: 65%;
}

#yuaxvcplfa .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#yuaxvcplfa .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#yuaxvcplfa .gt_indent_1 {
  text-indent: 5px;
}

#yuaxvcplfa .gt_indent_2 {
  text-indent: 10px;
}

#yuaxvcplfa .gt_indent_3 {
  text-indent: 15px;
}

#yuaxvcplfa .gt_indent_4 {
  text-indent: 20px;
}

#yuaxvcplfa .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header gt_col_headings">
<th id="<strong>Characteristic</strong>" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col"><strong>Characteristic</strong></th>
<th id="<strong>HR</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>HR</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
<th id="<strong>95% CI</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>95% CI</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
<th id="<strong>p-value</strong>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>p-value</strong></th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="label">trt</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="ci"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">age</td>
<td class="gt_row gt_center" headers="estimate">1.01</td>
<td class="gt_row gt_center" headers="ci">0.99, 1.03</td>
<td class="gt_row gt_center" headers="p.value">0.4</td>
</tr>
</tbody><tfoot class="gt_footnotes">
<tr class="odd">
<td colspan="4" class="gt_footnote"><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span> HR = Hazard Ratio, CI = Confidence Interval</td>
</tr>
</tfoot>

</table>

</div>
</div>
</div>
<p>Hang on - what happened to the coefficient/HR for <code>trt</code>?? Well, this is the BIG downside to this approach. By stratifying on a covariate, you no longer get any information returned about that covariate. So this method is really only fine if your offending variable isn’t a primary exposure of interest and you are just adjusting for it in the model. Otherwise you are somewhat shooting yourself in the foot if you actually want to know what that effect estimate is.</p>
</section>
<section id="incorporate-non-proportionality-into-the-model" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Incorporate Non-Proportionality into the Model</h1>
<p>In this approach we use time-varying (-dependent) coefficients. In other words we allow the HR to vary over time for the offending covariate, thus negating any need for the assumption of PH in the first place. There are two variants on these methodological theme - in the first instance we can define time periods where the HR looks relatively stable within each period but different across periods, and estimate different HR’s accordingly. These are called step functions. Alternatively, we can estimate a more continuous (smoothed) HR for the offending covariate over time. This provides more flexibility but at the cost of more complexity.</p>
<section id="step-functions" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="step-functions"><span class="header-section-number">3.1</span> Step functions</h2>
<p>To help decide how we might define time periods for our <code>trt</code> variable to estimate different HR’s within, it is helpful to inspect the output of our <code>cox.zph()</code> plot, so let’s revisit that now.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>sch_res <span class="ot">&lt;-</span>  <span class="fu">cox.zph</span>(vfit1)</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="fu">plot</span>(sch_res[<span class="dv">1</span>], <span class="at">hr =</span> T) <span class="co"># trt</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">3</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>The decision is ultimately arbitrary but I would probably divide this into two periods splitting time at about <code>100</code> days. My thinking on this is that the HR is larger within that first <code>100</code> days and then gradually declines thereafter. While it also appears non-monotonic (increasing and decreasing) in that early period, we can still aim to obtain an averaged effect over that time and then contrast that to the later period (this bit is not an exact science).</p>
<p>To estimate this model we return to our trusty <code>survSplit()</code> function to split time for each individual at the desired points (here <code>100</code> days) and then create an interaction term between the offending covariate and the time strata. We do this like so:</p>
<p><code>vfit4 &lt;- coxph(Surv(tstart, time, status) ~ age + trt:strata(tgroup), data = vdata2)</code></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># Create new df in CP form with splits at 100 days</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>vdata2 <span class="ot">&lt;-</span> <span class="fu">survSplit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span>., vdata1, <span class="at">cut =</span> <span class="dv">100</span>, <span class="at">episode =</span> <span class="st">"tgroup"</span>)</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co"># Cox model with stepped time-dependent coefficients</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>vfit4 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(tstart, time, status) <span class="sc">~</span> age <span class="sc">+</span> trt<span class="sc">:</span><span class="fu">strata</span>(tgroup), <span class="at">data =</span> vdata2)</span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="fu">tbl_regression</span>(vfit4, <span class="at">exp =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="oyiqmfhbbq" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#oyiqmfhbbq table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#oyiqmfhbbq thead, #oyiqmfhbbq tbody, #oyiqmfhbbq tfoot, #oyiqmfhbbq tr, #oyiqmfhbbq td, #oyiqmfhbbq th {
  border-style: none;
}

#oyiqmfhbbq p {
  margin: 0;
  padding: 0;
}

#oyiqmfhbbq .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#oyiqmfhbbq .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#oyiqmfhbbq .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#oyiqmfhbbq .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#oyiqmfhbbq .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#oyiqmfhbbq .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#oyiqmfhbbq .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#oyiqmfhbbq .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#oyiqmfhbbq .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#oyiqmfhbbq .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#oyiqmfhbbq .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#oyiqmfhbbq .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#oyiqmfhbbq .gt_spanner_row {
  border-bottom-style: hidden;
}

#oyiqmfhbbq .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#oyiqmfhbbq .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#oyiqmfhbbq .gt_from_md > :first-child {
  margin-top: 0;
}

#oyiqmfhbbq .gt_from_md > :last-child {
  margin-bottom: 0;
}

#oyiqmfhbbq .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#oyiqmfhbbq .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#oyiqmfhbbq .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#oyiqmfhbbq .gt_row_group_first td {
  border-top-width: 2px;
}

#oyiqmfhbbq .gt_row_group_first th {
  border-top-width: 2px;
}

#oyiqmfhbbq .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#oyiqmfhbbq .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#oyiqmfhbbq .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#oyiqmfhbbq .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#oyiqmfhbbq .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#oyiqmfhbbq .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#oyiqmfhbbq .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#oyiqmfhbbq .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#oyiqmfhbbq .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#oyiqmfhbbq .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#oyiqmfhbbq .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#oyiqmfhbbq .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#oyiqmfhbbq .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#oyiqmfhbbq .gt_left {
  text-align: left;
}

#oyiqmfhbbq .gt_center {
  text-align: center;
}

#oyiqmfhbbq .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#oyiqmfhbbq .gt_font_normal {
  font-weight: normal;
}

#oyiqmfhbbq .gt_font_bold {
  font-weight: bold;
}

#oyiqmfhbbq .gt_font_italic {
  font-style: italic;
}

#oyiqmfhbbq .gt_super {
  font-size: 65%;
}

#oyiqmfhbbq .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#oyiqmfhbbq .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#oyiqmfhbbq .gt_indent_1 {
  text-indent: 5px;
}

#oyiqmfhbbq .gt_indent_2 {
  text-indent: 10px;
}

#oyiqmfhbbq .gt_indent_3 {
  text-indent: 15px;
}

#oyiqmfhbbq .gt_indent_4 {
  text-indent: 20px;
}

#oyiqmfhbbq .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header gt_col_headings">
<th id="<strong>Characteristic</strong>" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col"><strong>Characteristic</strong></th>
<th id="<strong>HR</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>HR</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
<th id="<strong>95% CI</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>95% CI</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
<th id="<strong>p-value</strong>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>p-value</strong></th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="label">age</td>
<td class="gt_row gt_center" headers="estimate">1.01</td>
<td class="gt_row gt_center" headers="ci">0.99, 1.03</td>
<td class="gt_row gt_center" headers="p.value">0.4</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">trt * strata(tgroup)</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="ci"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;trt * tgroup=1</td>
<td class="gt_row gt_center" headers="estimate">1.46</td>
<td class="gt_row gt_center" headers="ci">0.93, 2.29</td>
<td class="gt_row gt_center" headers="p.value">0.10</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;trt * tgroup=2</td>
<td class="gt_row gt_center" headers="estimate">0.49</td>
<td class="gt_row gt_center" headers="ci">0.26, 0.92</td>
<td class="gt_row gt_center" headers="p.value">0.025</td>
</tr>
</tbody><tfoot class="gt_footnotes">
<tr class="odd">
<td colspan="4" class="gt_footnote"><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span> HR = Hazard Ratio, CI = Confidence Interval</td>
</tr>
</tfoot>

</table>

</div>
</div>
</div>
<p>So, in parameterising the model this way we estimate an average HR for the ‘effect’ of <code>trt</code> to be <code>~ 1.46</code> within the first <code>100</code> day period and and an average HR of <code>~ 0.49</code> thereafter. That fits in fairly nicely with what we see in the above plot.</p>
<p>The related test of PH gives:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">cox.zph</span>(vfit4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                   chisq df    p
age                 2.67  1 0.10
trt:strata(tgroup)  1.40  2 0.50
GLOBAL              3.94  3 0.27</code></pre>
</div>
</div>
<p>Section 4.1 of the <a href="https://cran.r-project.org/web/packages/survival/vignettes/timedep.pdf">time-dependent vignette</a> provides another example of the use of step functions and would be worth some of your time to read.</p>
</section>
<section id="continuous-time-dependent-coefficients" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="continuous-time-dependent-coefficients"><span class="header-section-number">3.2</span> Continuous time-dependent coefficients</h2>
<p>In evolving the step function approach we can think of chopping up time into smaller and smaller periods, to the point where we essentially end up estimating a continuous HR function over time. Of course, we don’t do this by manually splitting our data - that would be an impossible task. Luckily the <code>coxph()</code> function has the <em>time-transform</em> argument built into it, which I touched on briefly in the last post (more information can be found in Section 4.2 of the above vignette). This is our secret weapon in specifying time-dependent coefficients in the Cox model.</p>
<p>There are as many time transforms (functions of time) to select from as there are that you can think of - the choice is essentially endless. The general formulation of the time transform argument - <code>tt()</code> within a <code>coxph()</code> call (and using our model as an example) can be coded as:</p>
<p><code>coxph(Surv(time, status) ~ trt + age + tt(trt), tt = function(x,t,...) x * t, vdata1)</code></p>
<p>This represents a covariate-time interaction where we assume that the association between the covariate and the risk of the event is moderated as a linear function of time. As mentioned there are many other functions you could select, which you could then test in comparison to other functions and select the more appropriate model accordingly. Alternatively, you could just save yourself the effort and specify the most flexible time transform possible - one that involves fitting a restricted cubic spline to the interaction term. To do this we can use the <code>nsk()</code> function within the <code>tt()</code> argument and a general formulation of this model can be coded as:</p>
<p><code>coxph(Surv(time, status) ~ trt + age + tt(trt), tt = function(x, t, ...) x * nsk(t, df = 3), vdata1)</code></p>
<p>If we choose this option we are once again faced with the dilemma of interpreting model coefficients in the presence of spline terms. Let’s fit this model and look at the output:</p>
<p><code>vfit5 &lt;- coxph(Surv(time, status) ~ trt + age + tt(trt), tt = function(x, t, ...) x * nsk(t, df = 3), vdata1)</code></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="co"># Cox model with continuous time-dependent coefficient</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>vfit5 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">tt</span>(trt), <span class="at">tt =</span> <span class="cf">function</span>(x, t, ...) x <span class="sc">*</span> <span class="fu">nsk</span>(t, <span class="at">df =</span> <span class="dv">3</span>), vdata1)</span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="fu">tbl_regression</span>(vfit5, <span class="at">exp =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="heukuwfsim" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#heukuwfsim table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#heukuwfsim thead, #heukuwfsim tbody, #heukuwfsim tfoot, #heukuwfsim tr, #heukuwfsim td, #heukuwfsim th {
  border-style: none;
}

#heukuwfsim p {
  margin: 0;
  padding: 0;
}

#heukuwfsim .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#heukuwfsim .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#heukuwfsim .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#heukuwfsim .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#heukuwfsim .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#heukuwfsim .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#heukuwfsim .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#heukuwfsim .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#heukuwfsim .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#heukuwfsim .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#heukuwfsim .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#heukuwfsim .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#heukuwfsim .gt_spanner_row {
  border-bottom-style: hidden;
}

#heukuwfsim .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#heukuwfsim .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#heukuwfsim .gt_from_md > :first-child {
  margin-top: 0;
}

#heukuwfsim .gt_from_md > :last-child {
  margin-bottom: 0;
}

#heukuwfsim .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#heukuwfsim .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#heukuwfsim .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#heukuwfsim .gt_row_group_first td {
  border-top-width: 2px;
}

#heukuwfsim .gt_row_group_first th {
  border-top-width: 2px;
}

#heukuwfsim .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#heukuwfsim .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#heukuwfsim .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#heukuwfsim .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#heukuwfsim .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#heukuwfsim .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#heukuwfsim .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#heukuwfsim .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#heukuwfsim .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#heukuwfsim .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#heukuwfsim .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#heukuwfsim .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#heukuwfsim .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#heukuwfsim .gt_left {
  text-align: left;
}

#heukuwfsim .gt_center {
  text-align: center;
}

#heukuwfsim .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#heukuwfsim .gt_font_normal {
  font-weight: normal;
}

#heukuwfsim .gt_font_bold {
  font-weight: bold;
}

#heukuwfsim .gt_font_italic {
  font-style: italic;
}

#heukuwfsim .gt_super {
  font-size: 65%;
}

#heukuwfsim .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#heukuwfsim .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#heukuwfsim .gt_indent_1 {
  text-indent: 5px;
}

#heukuwfsim .gt_indent_2 {
  text-indent: 10px;
}

#heukuwfsim .gt_indent_3 {
  text-indent: 15px;
}

#heukuwfsim .gt_indent_4 {
  text-indent: 20px;
}

#heukuwfsim .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="<strong>Characteristic</strong>" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col"><strong>Characteristic</strong></th>
<th id="<strong>HR</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>HR</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
<th id="<strong>95% CI</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>95% CI</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
<th id="<strong>p-value</strong>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>p-value</strong></th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="label">trt</td>
<td class="gt_row gt_center" headers="estimate">0.72</td>
<td class="gt_row gt_center" headers="ci">0.24, 2.14</td>
<td class="gt_row gt_center" headers="p.value">0.6</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">age</td>
<td class="gt_row gt_center" headers="estimate">1.01</td>
<td class="gt_row gt_center" headers="ci">0.99, 1.03</td>
<td class="gt_row gt_center" headers="p.value">0.4</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">tt(trt)1</td>
<td class="gt_row gt_center" headers="estimate">2.27</td>
<td class="gt_row gt_center" headers="ci">0.72, 7.22</td>
<td class="gt_row gt_center" headers="p.value">0.2</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">tt(trt)2</td>
<td class="gt_row gt_center" headers="estimate">2.10</td>
<td class="gt_row gt_center" headers="ci">0.54, 8.23</td>
<td class="gt_row gt_center" headers="p.value">0.3</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">tt(trt)3</td>
<td class="gt_row gt_center" headers="estimate">0.83</td>
<td class="gt_row gt_center" headers="ci">0.26, 2.68</td>
<td class="gt_row gt_center" headers="p.value">0.8</td>
</tr>
</tbody><tfoot class="gt_footnotes">
<tr class="even">
<td colspan="4" class="gt_footnote"><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span> HR = Hazard Ratio, CI = Confidence Interval</td>
</tr>
</tfoot>

</table>

</div>
</div>
</div>
<p>Yep, we can’t easily interpret those coefficients for <code>trt</code>, and how the commensurate HR varies over time. Coefficients produced by models using simpler functions of time may be more amenable to direct interpretation but this is the trade-off when we choose splines to allow maximal flexibility in functional form estimation. As usual, however, we can plot these model results to assist us in visualising how the HR varies in a time-dependent manner. Unfortunately (yes, I know - there always seems to be a catch), we have to use the equivalent “first-principles” specification of the model that I introduced you to in the last post, to facilitate this. We can’t easily plot the results of a model containing a time-transform function. Instead, we first split our data at every event and then estimate the model using the same spline formulation as above. Let’s see what the equivalent model estimated from the counting process formulation of the equivalent single-row/person dataset, gives us:</p>
<p><code>vfit6 &lt;- coxph(Surv(tstart, time, status) ~ trt + age + trt:nsk(time, df = 3), vdata3)</code></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="co"># Vector of unique event times</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>event_times <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">with</span>(vdata1, time[status <span class="sc">==</span> <span class="dv">1</span>])))</span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="co"># Create new df in CP form with splits at every event time</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>vdata3 <span class="ot">&lt;-</span> <span class="fu">survSplit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span>., vdata1, <span class="at">cut =</span> event_times)</span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="co"># Fit Cox model with splined trt:time interaction (current times)</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>vfit6 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(tstart, time, status) <span class="sc">~</span> trt <span class="sc">+</span> age <span class="sc">+</span> trt<span class="sc">:</span><span class="fu">nsk</span>(time, <span class="at">df =</span> <span class="dv">3</span>), vdata3)</span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="fu">tbl_regression</span>(vfit6, <span class="at">exp =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="lxovvhxmyt" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#lxovvhxmyt table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#lxovvhxmyt thead, #lxovvhxmyt tbody, #lxovvhxmyt tfoot, #lxovvhxmyt tr, #lxovvhxmyt td, #lxovvhxmyt th {
  border-style: none;
}

#lxovvhxmyt p {
  margin: 0;
  padding: 0;
}

#lxovvhxmyt .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#lxovvhxmyt .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#lxovvhxmyt .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#lxovvhxmyt .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#lxovvhxmyt .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#lxovvhxmyt .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#lxovvhxmyt .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#lxovvhxmyt .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#lxovvhxmyt .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#lxovvhxmyt .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#lxovvhxmyt .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#lxovvhxmyt .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#lxovvhxmyt .gt_spanner_row {
  border-bottom-style: hidden;
}

#lxovvhxmyt .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#lxovvhxmyt .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#lxovvhxmyt .gt_from_md > :first-child {
  margin-top: 0;
}

#lxovvhxmyt .gt_from_md > :last-child {
  margin-bottom: 0;
}

#lxovvhxmyt .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#lxovvhxmyt .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#lxovvhxmyt .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#lxovvhxmyt .gt_row_group_first td {
  border-top-width: 2px;
}

#lxovvhxmyt .gt_row_group_first th {
  border-top-width: 2px;
}

#lxovvhxmyt .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#lxovvhxmyt .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#lxovvhxmyt .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#lxovvhxmyt .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#lxovvhxmyt .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#lxovvhxmyt .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#lxovvhxmyt .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#lxovvhxmyt .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#lxovvhxmyt .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#lxovvhxmyt .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#lxovvhxmyt .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#lxovvhxmyt .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#lxovvhxmyt .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#lxovvhxmyt .gt_left {
  text-align: left;
}

#lxovvhxmyt .gt_center {
  text-align: center;
}

#lxovvhxmyt .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#lxovvhxmyt .gt_font_normal {
  font-weight: normal;
}

#lxovvhxmyt .gt_font_bold {
  font-weight: bold;
}

#lxovvhxmyt .gt_font_italic {
  font-style: italic;
}

#lxovvhxmyt .gt_super {
  font-size: 65%;
}

#lxovvhxmyt .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#lxovvhxmyt .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#lxovvhxmyt .gt_indent_1 {
  text-indent: 5px;
}

#lxovvhxmyt .gt_indent_2 {
  text-indent: 10px;
}

#lxovvhxmyt .gt_indent_3 {
  text-indent: 15px;
}

#lxovvhxmyt .gt_indent_4 {
  text-indent: 20px;
}

#lxovvhxmyt .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header gt_col_headings">
<th id="<strong>Characteristic</strong>" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col"><strong>Characteristic</strong></th>
<th id="<strong>HR</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>HR</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
<th id="<strong>95% CI</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>95% CI</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
<th id="<strong>p-value</strong>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>p-value</strong></th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="label">trt</td>
<td class="gt_row gt_center" headers="estimate">0.72</td>
<td class="gt_row gt_center" headers="ci">0.24, 2.14</td>
<td class="gt_row gt_center" headers="p.value">0.6</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">age</td>
<td class="gt_row gt_center" headers="estimate">1.01</td>
<td class="gt_row gt_center" headers="ci">0.99, 1.03</td>
<td class="gt_row gt_center" headers="p.value">0.4</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">trt * nsk(time, df = 3)</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="ci"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;trt * NA</td>
<td class="gt_row gt_center" headers="estimate">2.27</td>
<td class="gt_row gt_center" headers="ci">0.72, 7.22</td>
<td class="gt_row gt_center" headers="p.value">0.2</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;trt * NA</td>
<td class="gt_row gt_center" headers="estimate">2.10</td>
<td class="gt_row gt_center" headers="ci">0.54, 8.23</td>
<td class="gt_row gt_center" headers="p.value">0.3</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;trt * NA</td>
<td class="gt_row gt_center" headers="estimate">0.83</td>
<td class="gt_row gt_center" headers="ci">0.26, 2.68</td>
<td class="gt_row gt_center" headers="p.value">0.8</td>
</tr>
</tbody><tfoot class="gt_footnotes">
<tr class="odd">
<td colspan="4" class="gt_footnote"><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span> HR = Hazard Ratio, CI = Confidence Interval</td>
</tr>
</tfoot>

</table>

</div>
</div>
</div>
<p>We see that the model output is identical comparing both <code>vfit5</code> and <code>vfit6</code>. This is entirely expected seeing the time-transform function splits each person’s single-row data at all event times in the background as part of the estimation process in <code>vfit5</code> (we just don’t see it). But that is exactly what we have replicated when we apply <code>trt:nsk(time, df = 3)</code> to <code>vfit6</code> in the manually split dataset.</p>
<p>One final thing to note is that we can’t use <code>cox.zph()</code> on models with <code>tt()</code> terms, and that is a design choice by the package author.</p>
<p>PH test on <code>vfit5</code> gives:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># cox.zph(vfit5)</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="fu">print</span>(<span class="st">"Error in cox.zph(vfit5) : function not defined for models with tt() terms"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Error in cox.zph(vfit5) : function not defined for models with tt() terms"</code></pre>
</div>
</div>
<p>And on <code>vfit6</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">cox.zph</span>(vfit6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                      chisq df    p
trt                    1.92  1 0.17
age                    2.47  1 0.12
trt:nsk(time, df = 3)  4.50  3 0.21
GLOBAL                 9.53  5 0.09</code></pre>
</div>
</div>
<section id="plot-time-varying-hr" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="plot-time-varying-hr"><span class="header-section-number">3.2.1</span> Plot time-varying HR</h3>
<p>Now let’s get back to plotting the HR for <code>trt</code> as a function of time. The code to do this is shown below, but to explain in words:</p>
<ol type="1">
<li><p>We start by creating a new dataframe based on a grid of observation times spanning <code>1000</code> days, a fixed value of <code>1</code> for <code>trt</code>, and a ‘placeholder’ value of <code>0</code> for <code>age</code> (we set this to <code>0</code> because the reference is <code>0</code> for all covariates in the model and we only want to predict the HR for a one-unit increase in <code>trt</code> - not for any additional ‘effect’ of <code>age</code>).</p></li>
<li><p>We then pass that new data to the <code>predict()</code> function asking to predict <code>type = "risk"</code> for <code>trt</code> at the specified value of <code>1</code>, at each new observation time - this effectively estimates the HR at each new observation time.</p></li>
<li><p>We then plot those predictions.</p></li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You may be wondering why I am plotting the HR on a log scale. The reason is that coefficients from the Cox model are <em>estimated on the log-hazard scale</em>, a linear scale in which the estimates have (asymptotically) normal distributions. Plotting HR’s on the same additive scale can result in misleading visual impressions of the magnitude of effect variation. Thus, it is in general better practice to display exponentiated effect estimates such as the HR on their native multiplicative scale and this can be achieved with a log-transform of the scale axis.</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="co"># Create newdat df</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>tdata <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">trt =</span> <span class="dv">1</span>, <span class="at">age =</span> <span class="dv">0</span>, <span class="at">time =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1000</span>, <span class="at">by =</span> <span class="dv">5</span>))</span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="co"># Predict HR </span></span>
<span id="cb20-4"><a href="#cb20-4"></a>yhat <span class="ot">&lt;-</span> <span class="fu">predict</span>(vfit6, <span class="at">newdata =</span> tdata, <span class="at">se.fit =</span> <span class="cn">TRUE</span>, <span class="at">type =</span> <span class="st">"risk"</span>, <span class="at">reference =</span> <span class="st">"zero"</span>)</span>
<span id="cb20-5"><a href="#cb20-5"></a>tdata<span class="sc">$</span>fit <span class="ot">&lt;-</span>  yhat<span class="sc">$</span>fit</span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="co"># Plot</span></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="fu">ggplot</span>(tdata, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> fit)) <span class="sc">+</span> </span>
<span id="cb20-8"><a href="#cb20-8"></a>  <span class="fu">geom_line</span>(<span class="at">col =</span> <span class="st">'#F8766D'</span>) <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">400</span>, <span class="at">by =</span> <span class="dv">50</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">400</span>)) <span class="sc">+</span></span>
<span id="cb20-10"><a href="#cb20-10"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">trans =</span> <span class="st">"log"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">1.5</span>, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb20-11"><a href="#cb20-11"></a>  <span class="fu">xlab</span>(<span class="st">"Observation Time"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"HR for Treatment"</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Cox Model - Time-varying HR for Treatment"</span>) <span class="sc">+</span></span>
<span id="cb20-12"><a href="#cb20-12"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>In the above plot I have decided to truncate observation time at <code>400</code> days, to make the x-axis appear less compressed (and given nothing much interesting happens after that). The plot suggests that the HR for <code>trt</code> initially increases, reaches a maximum at about <code>40</code> days and then gradually declines. We can replot the Schoenfeld residuals and associated smoothing function (below) as a means to contrast the functional forms for this time-varying effect. It is a little difficult to directly compare them due to some differences in the axis scaling, but we obtain the general impression that both plots display a similar time-varying form for the HR of <code>trt</code>. This gives us confidence that the time-varying HR we have estimated is not an unreasonable result.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>sch_res <span class="ot">&lt;-</span>  <span class="fu">cox.zph</span>(vfit1)</span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="fu">plot</span>(sch_res[<span class="dv">1</span>], <span class="at">hr =</span> T) <span class="co"># trt</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">3</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="estimate-hr-at-times-of-interest" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="estimate-hr-at-times-of-interest"><span class="header-section-number">3.2.2</span> Estimate HR at times of interest</h3>
<p>We can take this further and actually calculate HR’s (and their 95% C.I.’s) at desired times of interest. Say we want to know the HR for <code>trt</code> at <code>5</code>, <code>40</code>, <code>100</code> and <code>400</code> days. We basically follow the same steps as above in terms of predicting, but instead of <code>type = "risk"</code> we specify <code>type = "lp"</code> which calculates the “linear predictor” or the log hazard ratio. We do this so we can <em>add/subtract</em> <code>1.96</code> times the standard error, then exponentiating the results to obtain the upper and lower 95% confidence limits. The code is shown below:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># Create newdat df with times of interest to predict at</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>tdata2 <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">trt =</span> <span class="dv">1</span>, <span class="at">age =</span> <span class="dv">0</span>, <span class="at">time =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">40</span>, <span class="dv">100</span>, <span class="dv">400</span>))</span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="co"># Predict HR and plot</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>yhat <span class="ot">&lt;-</span> <span class="fu">predict</span>(vfit6, <span class="at">newdata =</span> tdata2, <span class="at">se.fit =</span> <span class="cn">TRUE</span>, <span class="at">type =</span> <span class="st">"lp"</span>, <span class="at">reference =</span> <span class="st">"zero"</span>)</span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="co"># Calculate HR's and 95% CI's</span></span>
<span id="cb22-6"><a href="#cb22-6"></a>estimates <span class="ot">&lt;-</span>  <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">40</span>, <span class="dv">100</span>, <span class="dv">400</span>),</span>
<span id="cb22-7"><a href="#cb22-7"></a>                         <span class="at">HR =</span> <span class="fu">exp</span>(yhat<span class="sc">$</span>fit), </span>
<span id="cb22-8"><a href="#cb22-8"></a>                         <span class="st">`</span><span class="at">Lower CI</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">exp</span>(yhat<span class="sc">$</span>fit <span class="sc">-</span> (<span class="fl">1.96</span><span class="sc">*</span>yhat<span class="sc">$</span>se.fit)),</span>
<span id="cb22-9"><a href="#cb22-9"></a>                         <span class="st">`</span><span class="at">Upper CI</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">exp</span>(yhat<span class="sc">$</span>fit <span class="sc">+</span> (<span class="fl">1.96</span><span class="sc">*</span>yhat<span class="sc">$</span>se.fit)))</span>
<span id="cb22-10"><a href="#cb22-10"></a>estimates <span class="sc">|&gt;</span> </span>
<span id="cb22-11"><a href="#cb22-11"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Time</th>
<th style="text-align: center;">HR</th>
<th style="text-align: center;">Lower.CI</th>
<th style="text-align: center;">Upper.CI</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">0.80</td>
<td style="text-align: center;">0.30</td>
<td style="text-align: center;">2.10</td>
</tr>
<tr class="even">
<td style="text-align: center;">40</td>
<td style="text-align: center;">1.92</td>
<td style="text-align: center;">0.95</td>
<td style="text-align: center;">3.88</td>
</tr>
<tr class="odd">
<td style="text-align: center;">100</td>
<td style="text-align: center;">0.93</td>
<td style="text-align: center;">0.52</td>
<td style="text-align: center;">1.67</td>
</tr>
<tr class="even">
<td style="text-align: center;">400</td>
<td style="text-align: center;">0.38</td>
<td style="text-align: center;">0.12</td>
<td style="text-align: center;">1.19</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
</section>
<section id="use-a-different-type-of-model" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Use a Different Type of Model</h1>
<p>The final broad approach to dealing with the problem of non-proportional hazards is to forego the Cox model entirely and use a different type of model. The two options I will discuss here fall into the category of <a href="https://msni-stats-tips.netlify.app/posts/021_01nov_2024/#parametric-exponential-weibull-log-normal-etc">parametric survival models</a> - these differ from the Cox model in that the baseline hazard is fully specified according to a known statistical distribution, rather than being estimated empirically as in the case of the semi-parametric Cox.</p>
<section id="accelerated-failure-time-model" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="accelerated-failure-time-model"><span class="header-section-number">4.1</span> Accelerated failure time model</h2>
<p>Accelerated failure time (AFT) models provide an alternative parameterisation to their PH counterparts. Whereas a PH model assumes that the ‘effect’ of a covariate is to <strong>multiply the hazard</strong> by some constant, an AFT model assumes that the ‘effect’ of a covariate is to <strong>multiply the time</strong> to the event by some constant - in other words, accelerate or decelerate survival time. Rather than a HR, one calculates a Time Ratio (TR), with a TR &gt; <code>1</code> indicating that the covariate accelerates survival time (longer survival) and a TR &lt; <code>1</code> indicating that the covariate decelerates survival time (shorter survival).</p>
<p>Fitting an AFT survival model can be achieved in <code>R</code> using the <a href="https://www.rdocumentation.org/packages/survival/versions/3.8-3/topics/survreg"><code>survreg()</code></a> function in the <code>survival</code> package. The standard distributions one can select to model survival times include the weibull, exponential (a special case of the weibull distribution), gaussian, logistic, lognormal, and loglogistic. It is important to note that the weibull and exponential distributions have both a PH and an AFT interpretation, so it is therefore NOT theoretically sound to select one of these distributions - even in the AFT parameterisation - as an alternative to the Cox model when you already know that the PH assumption has been violated. When we want to consider an AFT model as an alternative for failed PH, we should select a distribution that has exclusively AFT properties, and the lognormal seems to be a reasonable place to start.</p>
<p>To be honest I have never had need to fit one of these models and so I have little experience in their application - I’m not providing a worked example for that reason. But that doesn’t mean you shouldn’t consider them if the need should arise. There are many advantages that parametric survival models have over the Cox model and some of these are outlined in my <a href="https://msni-stats-tips.netlify.app/posts/021_01nov_2024/#parametric-exponential-weibull-log-normal-etc">previous post</a>. A notable disadvantage, however, is the need to actually select a survival distribution and this requires some idea of what you think the baseline hazard should look like - something that isn’t always easy to know. Therefore, when I decide to move beyond the Cox model, I tend to go straight to Royston-Parmar models, which I believe incorporate the best of both semi-parametric and parametric survival models. Let’s take a look at them now.</p>
</section>
<section id="flexible-parametric-royston-parmar-survival-model" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="flexible-parametric-royston-parmar-survival-model"><span class="header-section-number">4.2</span> Flexible parametric (Royston-Parmar) survival model</h2>
<p>I suspect flexible parametric survival (also known as Royston-Parmar [RP]) models are both underutilised and underrated in the statistical and research communities. But I think they are great and I am trying to incorporate them more into any survival work that I do. Unfortunately there are not a lot of online resources out there on RP models but <a href="https://journals.sagepub.com/doi/pdf/10.1177/1536867x0900900206">here</a>, <a href="https://www.tandfonline.com/doi/full/10.1080/03610918.2019.1634201#d1e333">here</a>, <a href="https://pclambert.net/pdf/Stata2024_Germany_Paul_Lambert.pdf">here</a> and <a href="https://www.pauldickman.com/pdf/talk-milan-mar2023.pdf">here</a> are good places to start.</p>
<p>The basis of the RP model is the use of a restricted cubic spline to model the log cumulative baseline hazard function. This provides as much flexibility as the Cox model in the estimation of the baseline hazard while still being fully specified (and not being constrained to a specific distribution as in the standard parametric modelling approach). The immediate benefits are clear - we don’t need to worry about choosing a particular distribution for our survival times (advantage of the Cox model), yet we can easily predict any survival quantity we want (advantage of the parametric model), explicitly because the model returns the shape of the (unassumed) baseline hazard function. It has been said that “…if all you are interested in is the HR, than the Cox model is for you” (I just can’t remember where). Parametric models can do this and more, making the estimation of not only the HR but additional survival quantities such as survival functions, hazard functions, restricted mean survival times, etc, relatively straightforward. Now, having said all of that I’m not meaning to imply that we should never use the Cox model, but sometimes it’s just helpful to know that there are other options available available to use.</p>
<p>I tend to do most of RP modelling work in <code>Stata</code> using the <a href="https://pclambert.net/software/stpm3.html"><code>stpm3</code></a> function, but the equivalent go to package in <code>R</code> is <a href="https://cran.r-project.org/web/packages/rstpm2/index.html"><code>rstpm2</code></a>. Some time ago I performed an analysis in both environments and ended up with the same results, so I think you should be fine using the latter if you don’t have access to <code>Stata</code>. Ok, enough talking - let’s actually run an RP model incorporating a time-varying effect for our <code>trt</code> variable.</p>
<p>The specification of the <code>stpm2</code> model is relatively straightforward, but there are two spline terms that you need to set the degrees of freedom (<code>df</code>) for. The first is the log cumulative baseline hazard function which determines the overall shape of the baseline hazard - essentially the foundation of the model upon which all estimation is based. This is done with the primary <code>df</code> argument. Then if we have a covariate that fails PH testing and want to incorporate a time-varying effect for it, we do that with the <code>tvc</code> argument. In models that incorporate splines in any context, there is always the question of “How wiggly do I make them?” and that is determined by the <code>df</code>. I tend to follow the advice published in this <a href="https://www.tandfonline.com/doi/full/10.1080/03610918.2019.1634201#d1e333">paper</a> by some of the experts in this modelling framework:</p>
<p>“Our usual starting point is to use 5 degrees of freedom for the baseline and 3 degrees of freedom for any time-dependent effects. This is likely to capture most complex shapes. We would then inspect the AIC and BIC for a selection of models with more and less degrees of freedom to see if we had strong evidence of needing a more simple or more complex model.”</p>
<p>Based on this, for our model at hand I have ended up specifying <code>df = 3</code> on both the baseline and the time-dependent effect for <code>trt</code>:</p>
<p><code>vfit7 &lt;- stpm2(Surv(time, status) ~ trt + age, data = vdata1, df = 3, tvc = list(trt = 3))</code></p>
<p>Unfortunately <code>tbl_regression()</code> does not play nicely with <code>rstpm2</code> so I will just have to show you the raw model output as is (forgive the ugliness):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># RP model with time-varying effect on trt</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="fu">library</span>(rstpm2)</span>
<span id="cb23-3"><a href="#cb23-3"></a>vfit7 <span class="ot">&lt;-</span> <span class="fu">stpm2</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt <span class="sc">+</span> age, <span class="at">data =</span> vdata1, <span class="at">df =</span> <span class="dv">3</span>, <span class="at">tvc =</span> <span class="fu">list</span>(<span class="at">trt =</span> <span class="dv">3</span>))</span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="fu">summary</span>(vfit7)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Maximum likelihood estimation

Call:
stpm2(formula = Surv(time, status) ~ trt + age, data = vdata1, 
    df = 3, tvc = list(trt = 3))

Coefficients:
                                          Estimate Std. Error z value     Pr(z)
(Intercept)                             -6.8125275  1.4084469 -4.8369 1.319e-06
trt                                      1.4354501  1.6239300  0.8839   0.37673
age                                      0.0097779  0.0095828  1.0204   0.30756
nsx(log(time), df = 3)1                  4.3985534  0.8131604  5.4092 6.330e-08
nsx(log(time), df = 3)2                 12.1211268  2.5626905  4.7298 2.247e-06
nsx(log(time), df = 3)3                  6.1735733  0.7030626  8.7810 &lt; 2.2e-16
nsx(log(time), df = 3)1:as.numeric(trt) -0.3108192  1.0381000 -0.2994   0.76463
nsx(log(time), df = 3)2:as.numeric(trt) -3.4411331  3.2041055 -1.0740   0.28283
nsx(log(time), df = 3)3:as.numeric(trt) -1.6826010  0.8625165 -1.9508   0.05108
                                           
(Intercept)                             ***
trt                                        
age                                        
nsx(log(time), df = 3)1                 ***
nsx(log(time), df = 3)2                 ***
nsx(log(time), df = 3)3                 ***
nsx(log(time), df = 3)1:as.numeric(trt)    
nsx(log(time), df = 3)2:as.numeric(trt)    
nsx(log(time), df = 3)3:as.numeric(trt) .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

-2 log L: 1482.644 </code></pre>
</div>
</div>
<p>This is no easier to interpret than other model with spline terms included and as usual it is better if we plot the model results. Prediction following <code>stpm2</code> is a little different to that for the Cox model but essentially does the same thing. We first specify a new dataframe to predict on and then use the <code>exposed</code> argument to show the difference in the covariate values that we want to estimate an effect for.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># Predict HR</span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="co"># Note that it doesn't matter what we set the age values to in this case as there is no interaction between trt and age (i.e. the HR for trt is the same regardless of age). But we need to specify something otherwise predict will complain.</span></span>
<span id="cb25-3"><a href="#cb25-3"></a>pred_hrs <span class="ot">&lt;-</span> <span class="fu">predict</span>(vfit7, <span class="at">type =</span> <span class="st">"hr"</span>,</span>
<span id="cb25-4"><a href="#cb25-4"></a>                    <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1000</span>, <span class="at">by =</span> <span class="dv">5</span>), <span class="at">trt =</span> <span class="dv">0</span>, <span class="at">age =</span> <span class="dv">20</span>), <span class="co"># age value = placeholder</span></span>
<span id="cb25-5"><a href="#cb25-5"></a>                    <span class="at">exposed =</span> <span class="cf">function</span>(data) <span class="fu">transform</span>(data, <span class="at">trt =</span> <span class="dv">1</span>, <span class="at">age =</span> <span class="dv">20</span>), <span class="co"># age value = placeholder</span></span>
<span id="cb25-6"><a href="#cb25-6"></a>                    <span class="at">full =</span> <span class="cn">TRUE</span>, <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="co"># Now plot</span></span>
<span id="cb25-8"><a href="#cb25-8"></a><span class="fu">ggplot</span>(pred_hrs, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> Estimate)) <span class="sc">+</span> </span>
<span id="cb25-9"><a href="#cb25-9"></a>  <span class="fu">geom_line</span>(<span class="at">col =</span> <span class="st">'#00BFC4'</span>) <span class="sc">+</span> </span>
<span id="cb25-10"><a href="#cb25-10"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">400</span>, <span class="at">by =</span> <span class="dv">50</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">400</span>)) <span class="sc">+</span></span>
<span id="cb25-11"><a href="#cb25-11"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">trans =</span> <span class="st">"log"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">1.5</span>, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb25-12"><a href="#cb25-12"></a>  <span class="fu">xlab</span>(<span class="st">"Observation Time"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"HR for Treatment"</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"RP Model - Time-varying HR for Treatment"</span>) <span class="sc">+</span></span>
<span id="cb25-13"><a href="#cb25-13"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>This looks quite similar to the plot for the Cox model above. As we did for the Cox model, let’s estimate the HR from the RP model at the same times of interest.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="co"># Calculate HR's and 95% CI's</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>estimates <span class="ot">&lt;-</span> <span class="fu">predict</span>(vfit7, <span class="at">type =</span> <span class="st">"hr"</span>,</span>
<span id="cb26-3"><a href="#cb26-3"></a>                    <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">40</span>, <span class="dv">100</span>, <span class="dv">400</span>), <span class="at">trt =</span> <span class="dv">0</span>, <span class="at">age =</span> <span class="dv">20</span>), <span class="co"># age value = placeholder</span></span>
<span id="cb26-4"><a href="#cb26-4"></a>                    <span class="at">exposed =</span> <span class="cf">function</span>(data) <span class="fu">transform</span>(data, <span class="at">trt =</span> <span class="dv">1</span>, <span class="at">age =</span> <span class="dv">20</span>), <span class="co"># age value = placeholder</span></span>
<span id="cb26-5"><a href="#cb26-5"></a>                    <span class="at">full =</span> <span class="cn">TRUE</span>, <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-6"><a href="#cb26-6"></a><span class="co"># Select relevant columns and rename</span></span>
<span id="cb26-7"><a href="#cb26-7"></a>estimates <span class="ot">&lt;-</span>  estimates <span class="sc">|&gt;</span> </span>
<span id="cb26-8"><a href="#cb26-8"></a>  <span class="fu">select</span>(time, Estimate, lower, upper) <span class="sc">|&gt;</span> </span>
<span id="cb26-9"><a href="#cb26-9"></a>  <span class="fu">rename</span>(<span class="at">Time =</span> time,</span>
<span id="cb26-10"><a href="#cb26-10"></a>         <span class="at">HR =</span> Estimate,</span>
<span id="cb26-11"><a href="#cb26-11"></a>         <span class="st">`</span><span class="at">Lower CI</span><span class="st">`</span> <span class="ot">=</span> lower,</span>
<span id="cb26-12"><a href="#cb26-12"></a>         <span class="st">`</span><span class="at">Upper CI</span><span class="st">`</span> <span class="ot">=</span> upper)</span>
<span id="cb26-13"><a href="#cb26-13"></a>estimates <span class="sc">|&gt;</span> </span>
<span id="cb26-14"><a href="#cb26-14"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Time</th>
<th style="text-align: center;">HR</th>
<th style="text-align: center;">Lower CI</th>
<th style="text-align: center;">Upper CI</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">1.18</td>
<td style="text-align: center;">0.49</td>
<td style="text-align: center;">2.86</td>
</tr>
<tr class="even">
<td style="text-align: center;">40</td>
<td style="text-align: center;">1.39</td>
<td style="text-align: center;">0.83</td>
<td style="text-align: center;">2.33</td>
</tr>
<tr class="odd">
<td style="text-align: center;">100</td>
<td style="text-align: center;">1.24</td>
<td style="text-align: center;">0.71</td>
<td style="text-align: center;">2.17</td>
</tr>
<tr class="even">
<td style="text-align: center;">400</td>
<td style="text-align: center;">0.30</td>
<td style="text-align: center;">0.13</td>
<td style="text-align: center;">0.69</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>For interest and before we wrap this up, let’s superimpose the time-varying HR curves from both the Cox and RP models to enable a more direct comparison.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># Tidy RP pred output</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>pred_hrs <span class="ot">&lt;-</span>  pred_hrs <span class="sc">|&gt;</span> </span>
<span id="cb27-3"><a href="#cb27-3"></a>  <span class="fu">select</span>(time, Estimate) <span class="sc">|&gt;</span> </span>
<span id="cb27-4"><a href="#cb27-4"></a>  <span class="fu">slice</span>(<span class="sc">-</span><span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb27-5"><a href="#cb27-5"></a>  <span class="fu">mutate</span>(<span class="at">Model =</span> <span class="st">"Royston-Parmar"</span>)</span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="co"># Tidy Cox pred output</span></span>
<span id="cb27-7"><a href="#cb27-7"></a>tdata <span class="ot">&lt;-</span>  tdata <span class="sc">|&gt;</span> </span>
<span id="cb27-8"><a href="#cb27-8"></a>  <span class="fu">select</span>(time, fit) <span class="sc">|&gt;</span> </span>
<span id="cb27-9"><a href="#cb27-9"></a>  <span class="fu">slice</span>(<span class="sc">-</span><span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb27-10"><a href="#cb27-10"></a>  <span class="fu">rename</span>(<span class="at">Estimate =</span> fit) <span class="sc">|&gt;</span> </span>
<span id="cb27-11"><a href="#cb27-11"></a>  <span class="fu">mutate</span>(<span class="at">Model =</span> <span class="st">"Cox"</span>)</span>
<span id="cb27-12"><a href="#cb27-12"></a><span class="co"># Merge both sets of predictions</span></span>
<span id="cb27-13"><a href="#cb27-13"></a>preds_rp_cox <span class="ot">&lt;-</span>  <span class="fu">rbind</span>(pred_hrs, tdata) <span class="sc">|&gt;</span> </span>
<span id="cb27-14"><a href="#cb27-14"></a>  <span class="fu">arrange</span>(time)</span>
<span id="cb27-15"><a href="#cb27-15"></a><span class="co"># Plot</span></span>
<span id="cb27-16"><a href="#cb27-16"></a><span class="fu">ggplot</span>(preds_rp_cox, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> Estimate, <span class="at">color =</span> Model)) <span class="sc">+</span> </span>
<span id="cb27-17"><a href="#cb27-17"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb27-18"><a href="#cb27-18"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">400</span>, <span class="at">by =</span> <span class="dv">50</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">400</span>)) <span class="sc">+</span></span>
<span id="cb27-19"><a href="#cb27-19"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">trans =</span> <span class="st">"log"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">1.5</span>, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb27-20"><a href="#cb27-20"></a>  <span class="fu">xlab</span>(<span class="st">"Observation Time"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"HR for Treatment"</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Time-varying HR for Treatment"</span>) <span class="sc">+</span></span>
<span id="cb27-21"><a href="#cb27-21"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb27-22"><a href="#cb27-22"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>Ok, not perfectly congruent, but they both show a similar pattern in that there is an initial increase and then gradual decline in the ‘effect’ of <code>trt</code> over time. Keep in mind that semi- and fully-parametric models are quite different modelling frameworks so the fact that we some concordance in the output gives us more confidence in establishing the validity of our results. I like RP models so much that I will aim to make them the subject of one of these blog posts in the not too distant future.</p>
</section>
</section>
<section id="wrap-up" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Wrap-Up</h1>
<p>Ok - I’m sure you would agree that you need a break. My apologies if you feel like I’ve made you run the mental equivalent of a marathon in these last two posts. As you can now see, there is a lot one can potentially cover following the violation of what might appear to be a very simple assumption. Damn you - proportional hazards! Hopefully this has given you some of both knowledge and coding tools that you can put to use when next faced with this common problem in your survival analysis endeavours.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="pgseye/Weekly_Stats_Tips" data-repo-id="R_kgDOKvfOfQ" data-category="General" data-category-id="DIC_kwDOKvfOfc4CbFWq" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb28" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb28-1"><a href="#cb28-1"></a><span class="co">---</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="an">title:</span><span class="co"> "Are your Hazards Proportional? - What to do when it just ain't so (Part 2)"</span></span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="an">date:</span><span class="co"> 2025-07-25</span></span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="an">categories:</span><span class="co"> [code, concept, modelling, visualisation]</span></span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="co"># image: "images/plot.png"</span></span>
<span id="cb28-6"><a href="#cb28-6"></a><span class="an">description:</span><span class="co"> "The hazards of misunderstanding the hazard ratio."</span></span>
<span id="cb28-7"><a href="#cb28-7"></a><span class="co">---</span></span>
<span id="cb28-8"><a href="#cb28-8"></a></span>
<span id="cb28-9"><a href="#cb28-9"></a>Welcome back to Stats Tips after a brief mid-year break.</span>
<span id="cb28-10"><a href="#cb28-10"></a></span>
<span id="cb28-11"><a href="#cb28-11"></a>In the last post we discussed some approaches to the diagnosis of non-proportional hazards for a covariate in our Cox model.</span>
<span id="cb28-12"><a href="#cb28-12"></a></span>
<span id="cb28-13"><a href="#cb28-13"></a>And the big question I'm sure you're chomping at the bit to ask is "Well, what can we do about it?"</span>
<span id="cb28-14"><a href="#cb28-14"></a></span>
<span id="cb28-15"><a href="#cb28-15"></a>Ok, relax... there are in fact several things we can do. Today we are going to consider the remediation actions we can take when we are faced with this issue in our day-to-day work. To get us started and to introduce the concepts to you, I've broken those actions down broadly into four groups:</span>
<span id="cb28-16"><a href="#cb28-16"></a></span>
<span id="cb28-17"><a href="#cb28-17"></a><span class="ss">1.  </span>Model specification adjustments.</span>
<span id="cb28-18"><a href="#cb28-18"></a></span>
<span id="cb28-19"><a href="#cb28-19"></a><span class="ss">2.  </span>Use strata (categorical variables only).</span>
<span id="cb28-20"><a href="#cb28-20"></a></span>
<span id="cb28-21"><a href="#cb28-21"></a><span class="ss">3.  </span>Incorporate non-proportionality into the model (time-dependent coefficients).</span>
<span id="cb28-22"><a href="#cb28-22"></a></span>
<span id="cb28-23"><a href="#cb28-23"></a><span class="ss">    -   </span>Step functions (different HR's over different time intervals).</span>
<span id="cb28-24"><a href="#cb28-24"></a></span>
<span id="cb28-25"><a href="#cb28-25"></a><span class="ss">    -   </span>Continuous time-dependent coefficients (smoothed HR over time).</span>
<span id="cb28-26"><a href="#cb28-26"></a></span>
<span id="cb28-27"><a href="#cb28-27"></a><span class="ss">4.  </span>Use a different type of model.</span>
<span id="cb28-28"><a href="#cb28-28"></a></span>
<span id="cb28-29"><a href="#cb28-29"></a><span class="ss">    -   </span>Accelerated failure time model.</span>
<span id="cb28-30"><a href="#cb28-30"></a></span>
<span id="cb28-31"><a href="#cb28-31"></a><span class="ss">    -   </span>Flexible parametric (Royston-Parmar) survival model.</span>
<span id="cb28-32"><a href="#cb28-32"></a></span>
<span id="cb28-33"><a href="#cb28-33"></a>In providing examples of how we might implement each of these in <span class="in">`R`</span> we will return to the <span class="in">`veteran`</span> dataset that we used in the last post, so get that ready using the code below.</span>
<span id="cb28-34"><a href="#cb28-34"></a></span>
<span id="cb28-37"><a href="#cb28-37"></a><span class="in">```{r}</span></span>
<span id="cb28-38"><a href="#cb28-38"></a><span class="co">#| message: false</span></span>
<span id="cb28-39"><a href="#cb28-39"></a><span class="co">#| warning: false</span></span>
<span id="cb28-40"><a href="#cb28-40"></a><span class="fu">library</span>(survival)</span>
<span id="cb28-41"><a href="#cb28-41"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb28-42"><a href="#cb28-42"></a><span class="fu">library</span>(survminer)</span>
<span id="cb28-43"><a href="#cb28-43"></a><span class="fu">library</span>(gtsummary)</span>
<span id="cb28-44"><a href="#cb28-44"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb28-45"><a href="#cb28-45"></a><span class="co"># Load veteran data from survival package</span></span>
<span id="cb28-46"><a href="#cb28-46"></a>vdata1 <span class="ot">&lt;-</span>  veteran</span>
<span id="cb28-47"><a href="#cb28-47"></a><span class="co"># Make treatment variable equal to 0,1 instead of 1,2 (not necessary, but I just like to work with the former)</span></span>
<span id="cb28-48"><a href="#cb28-48"></a>vdata1<span class="sc">$</span>trt <span class="ot">&lt;-</span>  <span class="fu">as.numeric</span>(vdata1<span class="sc">$</span>trt) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb28-49"><a href="#cb28-49"></a><span class="co"># Create id variable and organise columns</span></span>
<span id="cb28-50"><a href="#cb28-50"></a>vdata1<span class="sc">$</span>id <span class="ot">&lt;-</span>  <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(vdata1)[<span class="dv">1</span>])</span>
<span id="cb28-51"><a href="#cb28-51"></a>vdata1 <span class="ot">&lt;-</span>  vdata1 <span class="sc">|&gt;</span> </span>
<span id="cb28-52"><a href="#cb28-52"></a>  <span class="fu">select</span>(id, time, status, trt, age)</span>
<span id="cb28-53"><a href="#cb28-53"></a><span class="in">```</span></span>
<span id="cb28-54"><a href="#cb28-54"></a></span>
<span id="cb28-55"><a href="#cb28-55"></a>Let's talk about these ideas in more detail now.</span>
<span id="cb28-56"><a href="#cb28-56"></a></span>
<span id="cb28-57"><a href="#cb28-57"></a><span class="fu"># Adjust Your Model Specification</span></span>
<span id="cb28-58"><a href="#cb28-58"></a></span>
<span id="cb28-59"><a href="#cb28-59"></a>This is something you can explore in your model before you take any of the subsequent actions that I describe. In fact, this is not really doing anything special at all in the treatment of non-proportional hazards. All you are doing here is attempting to optimise your model specification, and that's an ideal that we should aim to achieve in every model we make.</span>
<span id="cb28-60"><a href="#cb28-60"></a></span>
<span id="cb28-61"><a href="#cb28-61"></a>It may not be immediately intuitive, but tests for proportional hazards (PH) come after the model coefficients for the covariates have been estimated. If there is an error in the model for how the covariates are specified that can also lead to a failure of a PH test - in other words, the power of the test to detect non-proportionality is contingent on the correct specification of the model.</span>
<span id="cb28-62"><a href="#cb28-62"></a></span>
<span id="cb28-63"><a href="#cb28-63"></a>So what do I mean with all this talk of 'model specification'? Well, in the current context there are three things you can consider doing to optimise your model and facilitate PH testing success:</span>
<span id="cb28-64"><a href="#cb28-64"></a></span>
<span id="cb28-65"><a href="#cb28-65"></a><span class="ss">1.  </span>Check the functional form of your continuous covariates.</span>
<span id="cb28-66"><a href="#cb28-66"></a></span>
<span id="cb28-67"><a href="#cb28-67"></a><span class="ss">2.  </span>Check you haven't omitted any necessary interactions.</span>
<span id="cb28-68"><a href="#cb28-68"></a></span>
<span id="cb28-69"><a href="#cb28-69"></a><span class="ss">3.  </span>Check you haven't omitted any important variables.</span>
<span id="cb28-70"><a href="#cb28-70"></a></span>
<span id="cb28-71"><a href="#cb28-71"></a>The first point is simply stating that when you enter a continuous covariate in a model, the model assumes the relationship of that covariate with the outcome of interest (i.e. its functional form) is linear in nature. This can often be an unrealistic assumption, but it is one that is easily checked and fixed by allowing for potential non-linearity with the inclusion of a restricted cubic spline term on your covariate (<span class="co">[</span><span class="ot">see here)</span><span class="co">](https://msni-stats-tips.netlify.app/posts/009_05apr_2024/)</span>.</span>
<span id="cb28-72"><a href="#cb28-72"></a></span>
<span id="cb28-73"><a href="#cb28-73"></a>The second point is also not difficult to assess in your model. Consider whether there are any potential moderating effects of covariates on the association between any other covariate and the outcome. Test this with the inclusion of an interaction term.</span>
<span id="cb28-74"><a href="#cb28-74"></a></span>
<span id="cb28-75"><a href="#cb28-75"></a>Unfortunately, the third point is more difficult to do anything about as with observational data we typically don't know what we don't know. And if we do know another variable would be of value to incorporate in our model, we simply may not have any information on it. So you will be a bit more hamstrung here.</span>
<span id="cb28-76"><a href="#cb28-76"></a></span>
<span id="cb28-77"><a href="#cb28-77"></a>If you recall from the last post, the model fit exploring the association between <span class="in">`trt`</span> and <span class="in">`age`</span> and the risk of death, and the resulting GOF PH test from that model was:</span>
<span id="cb28-78"><a href="#cb28-78"></a></span>
<span id="cb28-79"><a href="#cb28-79"></a><span class="in">`vfit1 &lt;- coxph(Surv(time, status) ~ trt + age, vdata1)`</span></span>
<span id="cb28-80"><a href="#cb28-80"></a></span>
<span id="cb28-83"><a href="#cb28-83"></a><span class="in">```{r}</span></span>
<span id="cb28-84"><a href="#cb28-84"></a><span class="co"># Fit basic model with treatment and age as the only predictors</span></span>
<span id="cb28-85"><a href="#cb28-85"></a>vfit1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt <span class="sc">+</span> age, vdata1)</span>
<span id="cb28-86"><a href="#cb28-86"></a><span class="fu">tbl_regression</span>(vfit1, <span class="at">exp =</span> T)</span>
<span id="cb28-87"><a href="#cb28-87"></a><span class="co"># Test Schoenfeld residuals</span></span>
<span id="cb28-88"><a href="#cb28-88"></a>(sch_res <span class="ot">&lt;-</span>  <span class="fu">cox.zph</span>(vfit1))</span>
<span id="cb28-89"><a href="#cb28-89"></a><span class="in">```</span></span>
<span id="cb28-90"><a href="#cb28-90"></a></span>
<span id="cb28-91"><a href="#cb28-91"></a>Now, what happens if we include a spline term on age?</span>
<span id="cb28-92"><a href="#cb28-92"></a></span>
<span id="cb28-93"><a href="#cb28-93"></a><span class="in">`vfit2 &lt;- coxph(Surv(time, status) ~ trt + splines::ns(age,3), vdata1)`</span></span>
<span id="cb28-94"><a href="#cb28-94"></a></span>
<span id="cb28-97"><a href="#cb28-97"></a><span class="in">```{r}</span></span>
<span id="cb28-98"><a href="#cb28-98"></a><span class="co"># Refit model with spline on age</span></span>
<span id="cb28-99"><a href="#cb28-99"></a>vfit2 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt <span class="sc">+</span> splines<span class="sc">::</span><span class="fu">ns</span>(age,<span class="dv">3</span>), vdata1)</span>
<span id="cb28-100"><a href="#cb28-100"></a><span class="fu">tbl_regression</span>(vfit2, <span class="at">exp =</span> T)</span>
<span id="cb28-101"><a href="#cb28-101"></a><span class="co"># Test Schoenfeld residuals</span></span>
<span id="cb28-102"><a href="#cb28-102"></a>(sch_res <span class="ot">&lt;-</span>  <span class="fu">cox.zph</span>(vfit2))</span>
<span id="cb28-103"><a href="#cb28-103"></a><span class="in">```</span></span>
<span id="cb28-104"><a href="#cb28-104"></a></span>
<span id="cb28-105"><a href="#cb28-105"></a>Well there you go - we have already made things better! Unfortunately there is no free lunch and now that you have improved the test of PH by a functional form correction, you need to contend with the complexities involved with the interpretation of spline terms. As I outlined in my previous post on the use of splines, the coefficients are not directly interpretable and so the best option is always to plot your results. We can do that here for the HR for age with a little bit of help from the <span class="in">`emmeans`</span> and <span class="in">`data.table`</span> packages:</span>
<span id="cb28-106"><a href="#cb28-106"></a></span>
<span id="cb28-109"><a href="#cb28-109"></a><span class="in">```{r}</span></span>
<span id="cb28-110"><a href="#cb28-110"></a><span class="co">#| message: false</span></span>
<span id="cb28-111"><a href="#cb28-111"></a><span class="co">#| warning: false</span></span>
<span id="cb28-112"><a href="#cb28-112"></a><span class="fu">library</span>(emmeans)</span>
<span id="cb28-113"><a href="#cb28-113"></a><span class="co"># Estimate hazard rate at yearly intervals</span></span>
<span id="cb28-114"><a href="#cb28-114"></a>emm_df <span class="ot">&lt;-</span>  <span class="fu">emmeans</span>(vfit2, <span class="sc">~</span> age, <span class="at">at =</span> <span class="fu">list</span>(<span class="at">age =</span> <span class="fu">seq</span>(<span class="dv">30</span>, <span class="dv">80</span>, <span class="at">by =</span> <span class="dv">1</span>)), <span class="at">type =</span> <span class="st">"unlink"</span>)</span>
<span id="cb28-115"><a href="#cb28-115"></a>emm_df <span class="ot">&lt;-</span>  <span class="fu">data.frame</span>(emm_df)</span>
<span id="cb28-116"><a href="#cb28-116"></a><span class="co"># Calculate HR at yearly intervals by dividing each successive pair of hazard rates</span></span>
<span id="cb28-117"><a href="#cb28-117"></a><span class="fu">library</span>(data.table)</span>
<span id="cb28-118"><a href="#cb28-118"></a><span class="fu">setDT</span>(emm_df)[, pred_HR <span class="sc">:</span><span class="er">=</span> <span class="fu">c</span>(<span class="cn">NA</span>, response[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">/</span> response[<span class="sc">-</span>.N])]</span>
<span id="cb28-119"><a href="#cb28-119"></a><span class="co"># Plot HR for age over range of age</span></span>
<span id="cb28-120"><a href="#cb28-120"></a><span class="fu">ggplot</span>(emm_df, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> pred_HR, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb28-121"><a href="#cb28-121"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb28-122"><a href="#cb28-122"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb28-123"><a href="#cb28-123"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.2</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.2</span>, <span class="at">by =</span> <span class="fl">0.25</span>)) <span class="sc">+</span></span>
<span id="cb28-124"><a href="#cb28-124"></a>  <span class="fu">xlab</span>(<span class="st">"Age"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Predicted HR"</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Predicted HR for Age (as a function of Age)"</span>) <span class="sc">+</span></span>
<span id="cb28-125"><a href="#cb28-125"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>)</span>
<span id="cb28-126"><a href="#cb28-126"></a><span class="in">```</span></span>
<span id="cb28-127"><a href="#cb28-127"></a></span>
<span id="cb28-128"><a href="#cb28-128"></a><span class="fu"># Use Strata</span></span>
<span id="cb28-129"><a href="#cb28-129"></a></span>
<span id="cb28-130"><a href="#cb28-130"></a>The next simplest approach to dealing with a PH violation is to stratify on the offending covariate in your model. This provides additional flexibility in allowing for proportional hazards *within* each stratum (i.e. level) of the covariate, but for that definitional reason, really only works with *categorical* variables. In this stratified Cox model, **the regression coefficients are assumed to be the same in each stratum**, but the **baseline hazard functions may be completely different**. And that is how the problem of non-proportionality is circumvented in using this method.</span>
<span id="cb28-131"><a href="#cb28-131"></a></span>
<span id="cb28-132"><a href="#cb28-132"></a>Within the <span class="in">`coxph()`</span> model call it's a simple case of specifying a <span class="in">`strata()`</span> term. Let's do that now for <span class="in">`trt`</span>:</span>
<span id="cb28-133"><a href="#cb28-133"></a></span>
<span id="cb28-134"><a href="#cb28-134"></a><span class="in">`vfit3 &lt;- coxph(Surv(time, status) ~ trt + age + strata(trt), vdata1)`</span></span>
<span id="cb28-135"><a href="#cb28-135"></a></span>
<span id="cb28-138"><a href="#cb28-138"></a><span class="in">```{r}</span></span>
<span id="cb28-139"><a href="#cb28-139"></a>vfit3 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">strata</span>(trt), vdata1)</span>
<span id="cb28-140"><a href="#cb28-140"></a><span class="fu">tbl_regression</span>(vfit3, <span class="at">exp =</span> T)</span>
<span id="cb28-141"><a href="#cb28-141"></a><span class="in">```</span></span>
<span id="cb28-142"><a href="#cb28-142"></a></span>
<span id="cb28-143"><a href="#cb28-143"></a>Hang on - what happened to the coefficient/HR for <span class="in">`trt`</span>?? Well, this is the BIG downside to this approach. By stratifying on a covariate, you no longer get any information returned about that covariate. So this method is really only fine if your offending variable isn't a primary exposure of interest and you are just adjusting for it in the model. Otherwise you are somewhat shooting yourself in the foot if you actually want to know what that effect estimate is.</span>
<span id="cb28-144"><a href="#cb28-144"></a></span>
<span id="cb28-145"><a href="#cb28-145"></a><span class="fu"># Incorporate Non-Proportionality into the Model</span></span>
<span id="cb28-146"><a href="#cb28-146"></a></span>
<span id="cb28-147"><a href="#cb28-147"></a>In this approach we use time-varying (-dependent) coefficients. In other words we allow the HR to vary over time for the offending covariate, thus negating any need for the assumption of PH in the first place. There are two variants on these methodological theme - in the first instance we can define time periods where the HR looks relatively stable within each period but different across periods, and estimate different HR's accordingly. These are called step functions. Alternatively, we can estimate a more continuous (smoothed) HR for the offending covariate over time. This provides more flexibility but at the cost of more complexity.</span>
<span id="cb28-148"><a href="#cb28-148"></a></span>
<span id="cb28-149"><a href="#cb28-149"></a><span class="fu">## Step functions</span></span>
<span id="cb28-150"><a href="#cb28-150"></a></span>
<span id="cb28-151"><a href="#cb28-151"></a>To help decide how we might define time periods for our <span class="in">`trt`</span> variable to estimate different HR's within, it is helpful to inspect the output of our <span class="in">`cox.zph()`</span> plot, so let's revisit that now.</span>
<span id="cb28-152"><a href="#cb28-152"></a></span>
<span id="cb28-155"><a href="#cb28-155"></a><span class="in">```{r}</span></span>
<span id="cb28-156"><a href="#cb28-156"></a>sch_res <span class="ot">&lt;-</span>  <span class="fu">cox.zph</span>(vfit1)</span>
<span id="cb28-157"><a href="#cb28-157"></a><span class="fu">plot</span>(sch_res[<span class="dv">1</span>], <span class="at">hr =</span> T) <span class="co"># trt</span></span>
<span id="cb28-158"><a href="#cb28-158"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">3</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb28-159"><a href="#cb28-159"></a><span class="in">```</span></span>
<span id="cb28-160"><a href="#cb28-160"></a></span>
<span id="cb28-161"><a href="#cb28-161"></a>The decision is ultimately arbitrary but I would probably divide this into two periods splitting time at about <span class="in">`100`</span> days. My thinking on this is that the HR is larger within that first <span class="in">`100`</span> days and then gradually declines thereafter. While it also appears non-monotonic (increasing and decreasing) in that early period, we can still aim to obtain an averaged effect over that time and then contrast that to the later period (this bit is not an exact science).</span>
<span id="cb28-162"><a href="#cb28-162"></a></span>
<span id="cb28-163"><a href="#cb28-163"></a>To estimate this model we return to our trusty <span class="in">`survSplit()`</span> function to split time for each individual at the desired points (here <span class="in">`100`</span> days) and then create an interaction term between the offending covariate and the time strata. We do this like so:</span>
<span id="cb28-164"><a href="#cb28-164"></a></span>
<span id="cb28-165"><a href="#cb28-165"></a><span class="in">`vfit4 &lt;- coxph(Surv(tstart, time, status) ~ age + trt:strata(tgroup), data = vdata2)`</span></span>
<span id="cb28-166"><a href="#cb28-166"></a></span>
<span id="cb28-169"><a href="#cb28-169"></a><span class="in">```{r}</span></span>
<span id="cb28-170"><a href="#cb28-170"></a><span class="co"># Create new df in CP form with splits at 100 days</span></span>
<span id="cb28-171"><a href="#cb28-171"></a>vdata2 <span class="ot">&lt;-</span> <span class="fu">survSplit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span>., vdata1, <span class="at">cut =</span> <span class="dv">100</span>, <span class="at">episode =</span> <span class="st">"tgroup"</span>)</span>
<span id="cb28-172"><a href="#cb28-172"></a><span class="co"># Cox model with stepped time-dependent coefficients</span></span>
<span id="cb28-173"><a href="#cb28-173"></a>vfit4 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(tstart, time, status) <span class="sc">~</span> age <span class="sc">+</span> trt<span class="sc">:</span><span class="fu">strata</span>(tgroup), <span class="at">data =</span> vdata2)</span>
<span id="cb28-174"><a href="#cb28-174"></a><span class="fu">tbl_regression</span>(vfit4, <span class="at">exp =</span> T)</span>
<span id="cb28-175"><a href="#cb28-175"></a><span class="in">```</span></span>
<span id="cb28-176"><a href="#cb28-176"></a></span>
<span id="cb28-177"><a href="#cb28-177"></a>So, in parameterising the model this way we estimate an average HR for the 'effect' of <span class="in">`trt`</span> to be <span class="in">`~ 1.46`</span> within the first <span class="in">`100`</span> day period and and an average HR of <span class="in">`~ 0.49`</span> thereafter. That fits in fairly nicely with what we see in the above plot.</span>
<span id="cb28-178"><a href="#cb28-178"></a></span>
<span id="cb28-179"><a href="#cb28-179"></a>The related test of PH gives:</span>
<span id="cb28-180"><a href="#cb28-180"></a></span>
<span id="cb28-183"><a href="#cb28-183"></a><span class="in">```{r}</span></span>
<span id="cb28-184"><a href="#cb28-184"></a><span class="fu">cox.zph</span>(vfit4)</span>
<span id="cb28-185"><a href="#cb28-185"></a><span class="in">```</span></span>
<span id="cb28-186"><a href="#cb28-186"></a></span>
<span id="cb28-187"><a href="#cb28-187"></a>Section 4.1 of the <span class="co">[</span><span class="ot">time-dependent vignette</span><span class="co">](https://cran.r-project.org/web/packages/survival/vignettes/timedep.pdf)</span> provides another example of the use of step functions and would be worth some of your time to read.</span>
<span id="cb28-188"><a href="#cb28-188"></a></span>
<span id="cb28-189"><a href="#cb28-189"></a><span class="fu">## Continuous time-dependent coefficients</span></span>
<span id="cb28-190"><a href="#cb28-190"></a></span>
<span id="cb28-191"><a href="#cb28-191"></a>In evolving the step function approach we can think of chopping up time into smaller and smaller periods, to the point where we essentially end up estimating a continuous HR function over time. Of course, we don't do this by manually splitting our data - that would be an impossible task. Luckily the <span class="in">`coxph()`</span> function has the *time-transform* argument built into it, which I touched on briefly in the last post (more information can be found in Section 4.2 of the above vignette). This is our secret weapon in specifying time-dependent coefficients in the Cox model.</span>
<span id="cb28-192"><a href="#cb28-192"></a></span>
<span id="cb28-193"><a href="#cb28-193"></a>There are as many time transforms (functions of time) to select from as there are that you can think of - the choice is essentially endless. The general formulation of the time transform argument - <span class="in">`tt()`</span> within a <span class="in">`coxph()`</span> call (and using our model as an example) can be coded as:</span>
<span id="cb28-194"><a href="#cb28-194"></a></span>
<span id="cb28-195"><a href="#cb28-195"></a><span class="in">`coxph(Surv(time, status) ~ trt + age + tt(trt), tt = function(x,t,...) x * t, vdata1)`</span></span>
<span id="cb28-196"><a href="#cb28-196"></a></span>
<span id="cb28-197"><a href="#cb28-197"></a>This represents a covariate-time interaction where we assume that the association between the covariate and the risk of the event is moderated as a linear function of time. As mentioned there are many other functions you could select, which you could then test in comparison to other functions and select the more appropriate model accordingly. Alternatively, you could just save yourself the effort and specify the most flexible time transform possible - one that involves fitting a restricted cubic spline to the interaction term. To do this we can use the <span class="in">`nsk()`</span> function within the <span class="in">`tt()`</span> argument and a general formulation of this model can be coded as:</span>
<span id="cb28-198"><a href="#cb28-198"></a></span>
<span id="cb28-199"><a href="#cb28-199"></a><span class="in">`coxph(Surv(time, status) ~ trt + age + tt(trt), tt = function(x, t, ...) x * nsk(t, df = 3), vdata1)`</span></span>
<span id="cb28-200"><a href="#cb28-200"></a></span>
<span id="cb28-201"><a href="#cb28-201"></a>If we choose this option we are once again faced with the dilemma of interpreting model coefficients in the presence of spline terms. Let's fit this model and look at the output:</span>
<span id="cb28-202"><a href="#cb28-202"></a></span>
<span id="cb28-203"><a href="#cb28-203"></a><span class="in">`vfit5 &lt;- coxph(Surv(time, status) ~ trt + age + tt(trt), tt = function(x, t, ...) x * nsk(t, df = 3), vdata1)`</span></span>
<span id="cb28-204"><a href="#cb28-204"></a></span>
<span id="cb28-207"><a href="#cb28-207"></a><span class="in">```{r}</span></span>
<span id="cb28-208"><a href="#cb28-208"></a><span class="co">#| message: false</span></span>
<span id="cb28-209"><a href="#cb28-209"></a><span class="co">#| warning: false</span></span>
<span id="cb28-210"><a href="#cb28-210"></a><span class="co"># Cox model with continuous time-dependent coefficient</span></span>
<span id="cb28-211"><a href="#cb28-211"></a>vfit5 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">tt</span>(trt), <span class="at">tt =</span> <span class="cf">function</span>(x, t, ...) x <span class="sc">*</span> <span class="fu">nsk</span>(t, <span class="at">df =</span> <span class="dv">3</span>), vdata1)</span>
<span id="cb28-212"><a href="#cb28-212"></a><span class="fu">tbl_regression</span>(vfit5, <span class="at">exp =</span> T)</span>
<span id="cb28-213"><a href="#cb28-213"></a><span class="in">```</span></span>
<span id="cb28-214"><a href="#cb28-214"></a></span>
<span id="cb28-215"><a href="#cb28-215"></a>Yep, we can't easily interpret those coefficients for <span class="in">`trt`</span>, and how the commensurate HR varies over time. Coefficients produced by models using simpler functions of time may be more amenable to direct interpretation but this is the trade-off when we choose splines to allow maximal flexibility in functional form estimation. As usual, however, we can plot these model results to assist us in visualising how the HR varies in a time-dependent manner. Unfortunately (yes, I know - there always seems to be a catch), we have to use the equivalent "first-principles" specification of the model that I introduced you to in the last post, to facilitate this. We can't easily plot the results of a model containing a time-transform function. Instead, we first split our data at every event and then estimate the model using the same spline formulation as above. Let's see what the equivalent model estimated from the counting process formulation of the equivalent single-row/person dataset, gives us:</span>
<span id="cb28-216"><a href="#cb28-216"></a></span>
<span id="cb28-217"><a href="#cb28-217"></a><span class="in">`vfit6 &lt;- coxph(Surv(tstart, time, status) ~ trt + age + trt:nsk(time, df = 3), vdata3)`</span></span>
<span id="cb28-218"><a href="#cb28-218"></a></span>
<span id="cb28-221"><a href="#cb28-221"></a><span class="in">```{r}</span></span>
<span id="cb28-222"><a href="#cb28-222"></a><span class="co"># Vector of unique event times</span></span>
<span id="cb28-223"><a href="#cb28-223"></a>event_times <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">with</span>(vdata1, time[status <span class="sc">==</span> <span class="dv">1</span>])))</span>
<span id="cb28-224"><a href="#cb28-224"></a><span class="co"># Create new df in CP form with splits at every event time</span></span>
<span id="cb28-225"><a href="#cb28-225"></a>vdata3 <span class="ot">&lt;-</span> <span class="fu">survSplit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span>., vdata1, <span class="at">cut =</span> event_times)</span>
<span id="cb28-226"><a href="#cb28-226"></a><span class="co"># Fit Cox model with splined trt:time interaction (current times)</span></span>
<span id="cb28-227"><a href="#cb28-227"></a>vfit6 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(tstart, time, status) <span class="sc">~</span> trt <span class="sc">+</span> age <span class="sc">+</span> trt<span class="sc">:</span><span class="fu">nsk</span>(time, <span class="at">df =</span> <span class="dv">3</span>), vdata3)</span>
<span id="cb28-228"><a href="#cb28-228"></a><span class="fu">tbl_regression</span>(vfit6, <span class="at">exp =</span> T)</span>
<span id="cb28-229"><a href="#cb28-229"></a><span class="in">```</span></span>
<span id="cb28-230"><a href="#cb28-230"></a></span>
<span id="cb28-231"><a href="#cb28-231"></a>We see that the model output is identical comparing both <span class="in">`vfit5`</span> and <span class="in">`vfit6`</span>. This is entirely expected seeing the time-transform function splits each person's single-row data at all event times in the background as part of the estimation process in <span class="in">`vfit5`</span> (we just don't see it). But that is exactly what we have replicated when we apply <span class="in">`trt:nsk(time, df = 3)`</span> to <span class="in">`vfit6`</span> in the manually split dataset.</span>
<span id="cb28-232"><a href="#cb28-232"></a></span>
<span id="cb28-233"><a href="#cb28-233"></a>One final thing to note is that we can't use <span class="in">`cox.zph()`</span> on models with <span class="in">`tt()`</span> terms, and that is a design choice by the package author.</span>
<span id="cb28-234"><a href="#cb28-234"></a></span>
<span id="cb28-235"><a href="#cb28-235"></a>PH test on <span class="in">`vfit5`</span> gives:</span>
<span id="cb28-236"><a href="#cb28-236"></a></span>
<span id="cb28-239"><a href="#cb28-239"></a><span class="in">```{r}</span></span>
<span id="cb28-240"><a href="#cb28-240"></a><span class="co"># cox.zph(vfit5)</span></span>
<span id="cb28-241"><a href="#cb28-241"></a><span class="fu">print</span>(<span class="st">"Error in cox.zph(vfit5) : function not defined for models with tt() terms"</span>)</span>
<span id="cb28-242"><a href="#cb28-242"></a><span class="in">```</span></span>
<span id="cb28-243"><a href="#cb28-243"></a></span>
<span id="cb28-244"><a href="#cb28-244"></a>And on <span class="in">`vfit6`</span>:</span>
<span id="cb28-245"><a href="#cb28-245"></a></span>
<span id="cb28-248"><a href="#cb28-248"></a><span class="in">```{r}</span></span>
<span id="cb28-249"><a href="#cb28-249"></a><span class="fu">cox.zph</span>(vfit6)</span>
<span id="cb28-250"><a href="#cb28-250"></a><span class="in">```</span></span>
<span id="cb28-251"><a href="#cb28-251"></a></span>
<span id="cb28-252"><a href="#cb28-252"></a><span class="fu">### Plot time-varying HR</span></span>
<span id="cb28-253"><a href="#cb28-253"></a></span>
<span id="cb28-254"><a href="#cb28-254"></a>Now let's get back to plotting the HR for <span class="in">`trt`</span> as a function of time. The code to do this is shown below, but to explain in words:</span>
<span id="cb28-255"><a href="#cb28-255"></a></span>
<span id="cb28-256"><a href="#cb28-256"></a><span class="ss">1.  </span>We start by creating a new dataframe based on a grid of observation times spanning <span class="in">`1000`</span> days, a fixed value of <span class="in">`1`</span> for <span class="in">`trt`</span>, and a 'placeholder' value of <span class="in">`0`</span> for <span class="in">`age`</span> (we set this to <span class="in">`0`</span> because the reference is <span class="in">`0`</span> for all covariates in the model and we only want to predict the HR for a one-unit increase in <span class="in">`trt`</span> - not for any additional 'effect' of <span class="in">`age`</span>).</span>
<span id="cb28-257"><a href="#cb28-257"></a></span>
<span id="cb28-258"><a href="#cb28-258"></a><span class="ss">2.  </span>We then pass that new data to the <span class="in">`predict()`</span> function asking to predict <span class="in">`type = "risk"`</span> for <span class="in">`trt`</span> at the specified value of <span class="in">`1`</span>, at each new observation time - this effectively estimates the HR at each new observation time.</span>
<span id="cb28-259"><a href="#cb28-259"></a></span>
<span id="cb28-260"><a href="#cb28-260"></a><span class="ss">3.  </span>We then plot those predictions.</span>
<span id="cb28-261"><a href="#cb28-261"></a></span>
<span id="cb28-262"><a href="#cb28-262"></a>::: callout-note</span>
<span id="cb28-263"><a href="#cb28-263"></a>You may be wondering why I am plotting the HR on a log scale. The reason is that coefficients from the Cox model are *estimated on the log-hazard scale*, a linear scale in which the estimates have (asymptotically) normal distributions. Plotting HR's on the same additive scale can result in misleading visual impressions of the magnitude of effect variation. Thus, it is in general better practice to display exponentiated effect estimates such as the HR on their native multiplicative scale and this can be achieved with a log-transform of the scale axis.</span>
<span id="cb28-264"><a href="#cb28-264"></a>:::</span>
<span id="cb28-265"><a href="#cb28-265"></a></span>
<span id="cb28-268"><a href="#cb28-268"></a><span class="in">```{r}</span></span>
<span id="cb28-269"><a href="#cb28-269"></a><span class="co">#| message: false</span></span>
<span id="cb28-270"><a href="#cb28-270"></a><span class="co">#| warning: false</span></span>
<span id="cb28-271"><a href="#cb28-271"></a><span class="co"># Create newdat df</span></span>
<span id="cb28-272"><a href="#cb28-272"></a>tdata <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">trt =</span> <span class="dv">1</span>, <span class="at">age =</span> <span class="dv">0</span>, <span class="at">time =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1000</span>, <span class="at">by =</span> <span class="dv">5</span>))</span>
<span id="cb28-273"><a href="#cb28-273"></a><span class="co"># Predict HR </span></span>
<span id="cb28-274"><a href="#cb28-274"></a>yhat <span class="ot">&lt;-</span> <span class="fu">predict</span>(vfit6, <span class="at">newdata =</span> tdata, <span class="at">se.fit =</span> <span class="cn">TRUE</span>, <span class="at">type =</span> <span class="st">"risk"</span>, <span class="at">reference =</span> <span class="st">"zero"</span>)</span>
<span id="cb28-275"><a href="#cb28-275"></a>tdata<span class="sc">$</span>fit <span class="ot">&lt;-</span>  yhat<span class="sc">$</span>fit</span>
<span id="cb28-276"><a href="#cb28-276"></a><span class="co"># Plot</span></span>
<span id="cb28-277"><a href="#cb28-277"></a><span class="fu">ggplot</span>(tdata, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> fit)) <span class="sc">+</span> </span>
<span id="cb28-278"><a href="#cb28-278"></a>  <span class="fu">geom_line</span>(<span class="at">col =</span> <span class="st">'#F8766D'</span>) <span class="sc">+</span></span>
<span id="cb28-279"><a href="#cb28-279"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">400</span>, <span class="at">by =</span> <span class="dv">50</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">400</span>)) <span class="sc">+</span></span>
<span id="cb28-280"><a href="#cb28-280"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">trans =</span> <span class="st">"log"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">1.5</span>, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb28-281"><a href="#cb28-281"></a>  <span class="fu">xlab</span>(<span class="st">"Observation Time"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"HR for Treatment"</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Cox Model - Time-varying HR for Treatment"</span>) <span class="sc">+</span></span>
<span id="cb28-282"><a href="#cb28-282"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) </span>
<span id="cb28-283"><a href="#cb28-283"></a><span class="in">```</span></span>
<span id="cb28-284"><a href="#cb28-284"></a></span>
<span id="cb28-285"><a href="#cb28-285"></a>In the above plot I have decided to truncate observation time at <span class="in">`400`</span> days, to make the x-axis appear less compressed (and given nothing much interesting happens after that). The plot suggests that the HR for <span class="in">`trt`</span> initially increases, reaches a maximum at about <span class="in">`40`</span> days and then gradually declines. We can replot the Schoenfeld residuals and associated smoothing function (below) as a means to contrast the functional forms for this time-varying effect. It is a little difficult to directly compare them due to some differences in the axis scaling, but we obtain the general impression that both plots display a similar time-varying form for the HR of <span class="in">`trt`</span>. This gives us confidence that the time-varying HR we have estimated is not an unreasonable result.</span>
<span id="cb28-286"><a href="#cb28-286"></a></span>
<span id="cb28-289"><a href="#cb28-289"></a><span class="in">```{r}</span></span>
<span id="cb28-290"><a href="#cb28-290"></a>sch_res <span class="ot">&lt;-</span>  <span class="fu">cox.zph</span>(vfit1)</span>
<span id="cb28-291"><a href="#cb28-291"></a><span class="fu">plot</span>(sch_res[<span class="dv">1</span>], <span class="at">hr =</span> T) <span class="co"># trt</span></span>
<span id="cb28-292"><a href="#cb28-292"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">3</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb28-293"><a href="#cb28-293"></a><span class="in">```</span></span>
<span id="cb28-294"><a href="#cb28-294"></a></span>
<span id="cb28-295"><a href="#cb28-295"></a><span class="fu">### Estimate HR at times of interest</span></span>
<span id="cb28-296"><a href="#cb28-296"></a></span>
<span id="cb28-297"><a href="#cb28-297"></a>We can take this further and actually calculate HR's (and their 95% C.I.'s) at desired times of interest. Say we want to know the HR for <span class="in">`trt`</span> at <span class="in">`5`</span>, <span class="in">`40`</span>, <span class="in">`100`</span> and <span class="in">`400`</span> days. We basically follow the same steps as above in terms of predicting, but instead of <span class="in">`type = "risk"`</span> we specify <span class="in">`type = "lp"`</span> which calculates the "linear predictor" or the log hazard ratio. We do this so we can *add/subtract* <span class="in">`1.96`</span> times the standard error, then exponentiating the results to obtain the upper and lower 95% confidence limits. The code is shown below:</span>
<span id="cb28-298"><a href="#cb28-298"></a></span>
<span id="cb28-301"><a href="#cb28-301"></a><span class="in">```{r}</span></span>
<span id="cb28-302"><a href="#cb28-302"></a><span class="co"># Create newdat df with times of interest to predict at</span></span>
<span id="cb28-303"><a href="#cb28-303"></a>tdata2 <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">trt =</span> <span class="dv">1</span>, <span class="at">age =</span> <span class="dv">0</span>, <span class="at">time =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">40</span>, <span class="dv">100</span>, <span class="dv">400</span>))</span>
<span id="cb28-304"><a href="#cb28-304"></a><span class="co"># Predict HR and plot</span></span>
<span id="cb28-305"><a href="#cb28-305"></a>yhat <span class="ot">&lt;-</span> <span class="fu">predict</span>(vfit6, <span class="at">newdata =</span> tdata2, <span class="at">se.fit =</span> <span class="cn">TRUE</span>, <span class="at">type =</span> <span class="st">"lp"</span>, <span class="at">reference =</span> <span class="st">"zero"</span>)</span>
<span id="cb28-306"><a href="#cb28-306"></a><span class="co"># Calculate HR's and 95% CI's</span></span>
<span id="cb28-307"><a href="#cb28-307"></a>estimates <span class="ot">&lt;-</span>  <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">40</span>, <span class="dv">100</span>, <span class="dv">400</span>),</span>
<span id="cb28-308"><a href="#cb28-308"></a>                         <span class="at">HR =</span> <span class="fu">exp</span>(yhat<span class="sc">$</span>fit), </span>
<span id="cb28-309"><a href="#cb28-309"></a>                         <span class="st">`</span><span class="at">Lower CI</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">exp</span>(yhat<span class="sc">$</span>fit <span class="sc">-</span> (<span class="fl">1.96</span><span class="sc">*</span>yhat<span class="sc">$</span>se.fit)),</span>
<span id="cb28-310"><a href="#cb28-310"></a>                         <span class="st">`</span><span class="at">Upper CI</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">exp</span>(yhat<span class="sc">$</span>fit <span class="sc">+</span> (<span class="fl">1.96</span><span class="sc">*</span>yhat<span class="sc">$</span>se.fit)))</span>
<span id="cb28-311"><a href="#cb28-311"></a>estimates <span class="sc">|&gt;</span> </span>
<span id="cb28-312"><a href="#cb28-312"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb28-313"><a href="#cb28-313"></a><span class="in">```</span></span>
<span id="cb28-314"><a href="#cb28-314"></a></span>
<span id="cb28-315"><a href="#cb28-315"></a><span class="fu"># Use a Different Type of Model</span></span>
<span id="cb28-316"><a href="#cb28-316"></a></span>
<span id="cb28-317"><a href="#cb28-317"></a>The final broad approach to dealing with the problem of non-proportional hazards is to forego the Cox model entirely and use a different type of model. The two options I will discuss here fall into the category of <span class="co">[</span><span class="ot">parametric survival models</span><span class="co">](https://msni-stats-tips.netlify.app/posts/021_01nov_2024/#parametric-exponential-weibull-log-normal-etc)</span> - these differ from the Cox model in that the baseline hazard is fully specified according to a known statistical distribution, rather than being estimated empirically as in the case of the semi-parametric Cox.</span>
<span id="cb28-318"><a href="#cb28-318"></a></span>
<span id="cb28-319"><a href="#cb28-319"></a><span class="fu">## Accelerated failure time model</span></span>
<span id="cb28-320"><a href="#cb28-320"></a></span>
<span id="cb28-321"><a href="#cb28-321"></a>Accelerated failure time (AFT) models provide an alternative parameterisation to their PH counterparts. Whereas a PH model assumes that the 'effect' of a covariate is to **multiply the hazard** by some constant, an AFT model assumes that the 'effect' of a covariate is to **multiply the time** to the event by some constant - in other words, accelerate or decelerate survival time. Rather than a HR, one calculates a Time Ratio (TR), with a TR <span class="sc">\&gt;</span> <span class="in">`1`</span> indicating that the covariate accelerates survival time (longer survival) and a TR <span class="sc">\&lt;</span> <span class="in">`1`</span> indicating that the covariate decelerates survival time (shorter survival).</span>
<span id="cb28-322"><a href="#cb28-322"></a></span>
<span id="cb28-323"><a href="#cb28-323"></a>Fitting an AFT survival model can be achieved in <span class="in">`R`</span> using the <span class="co">[</span><span class="ot">`survreg()`</span><span class="co">](https://www.rdocumentation.org/packages/survival/versions/3.8-3/topics/survreg)</span> function in the <span class="in">`survival`</span> package. The standard distributions one can select to model survival times include the weibull, exponential (a special case of the weibull distribution), gaussian, logistic, lognormal, and loglogistic. It is important to note that the weibull and exponential distributions have both a PH and an AFT interpretation, so it is therefore NOT theoretically sound to select one of these distributions - even in the AFT parameterisation - as an alternative to the Cox model when you already know that the PH assumption has been violated. When we want to consider an AFT model as an alternative for failed PH, we should select a distribution that has exclusively AFT properties, and the lognormal seems to be a reasonable place to start.</span>
<span id="cb28-324"><a href="#cb28-324"></a></span>
<span id="cb28-325"><a href="#cb28-325"></a>To be honest I have never had need to fit one of these models and so I have little experience in their application - I'm not providing a worked example for that reason. But that doesn't mean you shouldn't consider them if the need should arise. There are many advantages that parametric survival models have over the Cox model and some of these are outlined in my <span class="co">[</span><span class="ot">previous post</span><span class="co">](https://msni-stats-tips.netlify.app/posts/021_01nov_2024/#parametric-exponential-weibull-log-normal-etc)</span>. A notable disadvantage, however, is the need to actually select a survival distribution and this requires some idea of what you think the baseline hazard should look like - something that isn't always easy to know. Therefore, when I decide to move beyond the Cox model, I tend to go straight to Royston-Parmar models, which I believe incorporate the best of both semi-parametric and parametric survival models. Let's take a look at them now.</span>
<span id="cb28-326"><a href="#cb28-326"></a></span>
<span id="cb28-327"><a href="#cb28-327"></a><span class="fu">## Flexible parametric (Royston-Parmar) survival model</span></span>
<span id="cb28-328"><a href="#cb28-328"></a></span>
<span id="cb28-329"><a href="#cb28-329"></a>I suspect flexible parametric survival (also known as Royston-Parmar <span class="sc">\[</span>RP<span class="sc">\]</span>) models are both underutilised and underrated in the statistical and research communities. But I think they are great and I am trying to incorporate them more into any survival work that I do. Unfortunately there are not a lot of online resources out there on RP models but <span class="co">[</span><span class="ot">here</span><span class="co">](https://journals.sagepub.com/doi/pdf/10.1177/1536867x0900900206)</span>, <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.tandfonline.com/doi/full/10.1080/03610918.2019.1634201#d1e333)</span>, <span class="co">[</span><span class="ot">here</span><span class="co">](https://pclambert.net/pdf/Stata2024_Germany_Paul_Lambert.pdf)</span> and <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.pauldickman.com/pdf/talk-milan-mar2023.pdf)</span> are good places to start.</span>
<span id="cb28-330"><a href="#cb28-330"></a></span>
<span id="cb28-331"><a href="#cb28-331"></a>The basis of the RP model is the use of a restricted cubic spline to model the log cumulative baseline hazard function. This provides as much flexibility as the Cox model in the estimation of the baseline hazard while still being fully specified (and not being constrained to a specific distribution as in the standard parametric modelling approach). The immediate benefits are clear - we don't need to worry about choosing a particular distribution for our survival times (advantage of the Cox model), yet we can easily predict any survival quantity we want (advantage of the parametric model), explicitly because the model returns the shape of the (unassumed) baseline hazard function. It has been said that "...if all you are interested in is the HR, than the Cox model is for you" (I just can't remember where). Parametric models can do this and more, making the estimation of not only the HR but additional survival quantities such as survival functions, hazard functions, restricted mean survival times, etc, relatively straightforward. Now, having said all of that I'm not meaning to imply that we should never use the Cox model, but sometimes it's just helpful to know that there are other options available available to use.</span>
<span id="cb28-332"><a href="#cb28-332"></a></span>
<span id="cb28-333"><a href="#cb28-333"></a>I tend to do most of RP modelling work in <span class="in">`Stata`</span> using the <span class="co">[</span><span class="ot">`stpm3`</span><span class="co">](https://pclambert.net/software/stpm3.html)</span> function, but the equivalent go to package in <span class="in">`R`</span> is <span class="co">[</span><span class="ot">`rstpm2`</span><span class="co">](https://cran.r-project.org/web/packages/rstpm2/index.html)</span>. Some time ago I performed an analysis in both environments and ended up with the same results, so I think you should be fine using the latter if you don't have access to <span class="in">`Stata`</span>. Ok, enough talking - let's actually run an RP model incorporating a time-varying effect for our <span class="in">`trt`</span> variable.</span>
<span id="cb28-334"><a href="#cb28-334"></a></span>
<span id="cb28-335"><a href="#cb28-335"></a>The specification of the <span class="in">`stpm2`</span> model is relatively straightforward, but there are two spline terms that you need to set the degrees of freedom (<span class="in">`df`</span>) for. The first is the log cumulative baseline hazard function which determines the overall shape of the baseline hazard - essentially the foundation of the model upon which all estimation is based. This is done with the primary <span class="in">`df`</span> argument. Then if we have a covariate that fails PH testing and want to incorporate a time-varying effect for it, we do that with the <span class="in">`tvc`</span> argument. In models that incorporate splines in any context, there is always the question of "How wiggly do I make them?" and that is determined by the <span class="in">`df`</span>. I tend to follow the advice published in this <span class="co">[</span><span class="ot">paper</span><span class="co">](https://www.tandfonline.com/doi/full/10.1080/03610918.2019.1634201#d1e333)</span> by some of the experts in this modelling framework:</span>
<span id="cb28-336"><a href="#cb28-336"></a></span>
<span id="cb28-337"><a href="#cb28-337"></a>"Our usual starting point is to use 5 degrees of freedom for the baseline and 3 degrees of freedom for any time-dependent effects. This is likely to capture most complex shapes. We would then inspect the AIC and BIC for a selection of models with more and less degrees of freedom to see if we had strong evidence of needing a more simple or more complex model."</span>
<span id="cb28-338"><a href="#cb28-338"></a></span>
<span id="cb28-339"><a href="#cb28-339"></a>Based on this, for our model at hand I have ended up specifying <span class="in">`df = 3`</span> on both the baseline and the time-dependent effect for <span class="in">`trt`</span>:</span>
<span id="cb28-340"><a href="#cb28-340"></a></span>
<span id="cb28-341"><a href="#cb28-341"></a><span class="in">`vfit7 &lt;- stpm2(Surv(time, status) ~ trt + age, data = vdata1, df = 3, tvc = list(trt = 3))`</span></span>
<span id="cb28-342"><a href="#cb28-342"></a></span>
<span id="cb28-343"><a href="#cb28-343"></a>Unfortunately <span class="in">`tbl_regression()`</span> does not play nicely with <span class="in">`rstpm2`</span> so I will just have to show you the raw model output as is (forgive the ugliness):</span>
<span id="cb28-344"><a href="#cb28-344"></a></span>
<span id="cb28-347"><a href="#cb28-347"></a><span class="in">```{r}</span></span>
<span id="cb28-348"><a href="#cb28-348"></a><span class="co">#| message: false</span></span>
<span id="cb28-349"><a href="#cb28-349"></a><span class="co">#| warning: false</span></span>
<span id="cb28-350"><a href="#cb28-350"></a><span class="co"># RP model with time-varying effect on trt</span></span>
<span id="cb28-351"><a href="#cb28-351"></a><span class="fu">library</span>(rstpm2)</span>
<span id="cb28-352"><a href="#cb28-352"></a>vfit7 <span class="ot">&lt;-</span> <span class="fu">stpm2</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt <span class="sc">+</span> age, <span class="at">data =</span> vdata1, <span class="at">df =</span> <span class="dv">3</span>, <span class="at">tvc =</span> <span class="fu">list</span>(<span class="at">trt =</span> <span class="dv">3</span>))</span>
<span id="cb28-353"><a href="#cb28-353"></a><span class="fu">summary</span>(vfit7)</span>
<span id="cb28-354"><a href="#cb28-354"></a><span class="in">```</span></span>
<span id="cb28-355"><a href="#cb28-355"></a></span>
<span id="cb28-356"><a href="#cb28-356"></a>This is no easier to interpret than other model with spline terms included and as usual it is better if we plot the model results. Prediction following <span class="in">`stpm2`</span> is a little different to that for the Cox model but essentially does the same thing. We first specify a new dataframe to predict on and then use the <span class="in">`exposed`</span> argument to show the difference in the covariate values that we want to estimate an effect for.</span>
<span id="cb28-357"><a href="#cb28-357"></a></span>
<span id="cb28-360"><a href="#cb28-360"></a><span class="in">```{r}</span></span>
<span id="cb28-361"><a href="#cb28-361"></a><span class="co">#| message: false</span></span>
<span id="cb28-362"><a href="#cb28-362"></a><span class="co">#| warning: false</span></span>
<span id="cb28-363"><a href="#cb28-363"></a><span class="co"># Predict HR</span></span>
<span id="cb28-364"><a href="#cb28-364"></a><span class="co"># Note that it doesn't matter what we set the age values to in this case as there is no interaction between trt and age (i.e. the HR for trt is the same regardless of age). But we need to specify something otherwise predict will complain.</span></span>
<span id="cb28-365"><a href="#cb28-365"></a>pred_hrs <span class="ot">&lt;-</span> <span class="fu">predict</span>(vfit7, <span class="at">type =</span> <span class="st">"hr"</span>,</span>
<span id="cb28-366"><a href="#cb28-366"></a>                    <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1000</span>, <span class="at">by =</span> <span class="dv">5</span>), <span class="at">trt =</span> <span class="dv">0</span>, <span class="at">age =</span> <span class="dv">20</span>), <span class="co"># age value = placeholder</span></span>
<span id="cb28-367"><a href="#cb28-367"></a>                    <span class="at">exposed =</span> <span class="cf">function</span>(data) <span class="fu">transform</span>(data, <span class="at">trt =</span> <span class="dv">1</span>, <span class="at">age =</span> <span class="dv">20</span>), <span class="co"># age value = placeholder</span></span>
<span id="cb28-368"><a href="#cb28-368"></a>                    <span class="at">full =</span> <span class="cn">TRUE</span>, <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-369"><a href="#cb28-369"></a><span class="co"># Now plot</span></span>
<span id="cb28-370"><a href="#cb28-370"></a><span class="fu">ggplot</span>(pred_hrs, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> Estimate)) <span class="sc">+</span> </span>
<span id="cb28-371"><a href="#cb28-371"></a>  <span class="fu">geom_line</span>(<span class="at">col =</span> <span class="st">'#00BFC4'</span>) <span class="sc">+</span> </span>
<span id="cb28-372"><a href="#cb28-372"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">400</span>, <span class="at">by =</span> <span class="dv">50</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">400</span>)) <span class="sc">+</span></span>
<span id="cb28-373"><a href="#cb28-373"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">trans =</span> <span class="st">"log"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">1.5</span>, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb28-374"><a href="#cb28-374"></a>  <span class="fu">xlab</span>(<span class="st">"Observation Time"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"HR for Treatment"</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"RP Model - Time-varying HR for Treatment"</span>) <span class="sc">+</span></span>
<span id="cb28-375"><a href="#cb28-375"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) </span>
<span id="cb28-376"><a href="#cb28-376"></a><span class="in">```</span></span>
<span id="cb28-377"><a href="#cb28-377"></a></span>
<span id="cb28-378"><a href="#cb28-378"></a>This looks quite similar to the plot for the Cox model above. As we did for the Cox model, let's estimate the HR from the RP model at the same times of interest.</span>
<span id="cb28-379"><a href="#cb28-379"></a></span>
<span id="cb28-382"><a href="#cb28-382"></a><span class="in">```{r}</span></span>
<span id="cb28-383"><a href="#cb28-383"></a><span class="co"># Calculate HR's and 95% CI's</span></span>
<span id="cb28-384"><a href="#cb28-384"></a>estimates <span class="ot">&lt;-</span> <span class="fu">predict</span>(vfit7, <span class="at">type =</span> <span class="st">"hr"</span>,</span>
<span id="cb28-385"><a href="#cb28-385"></a>                    <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">40</span>, <span class="dv">100</span>, <span class="dv">400</span>), <span class="at">trt =</span> <span class="dv">0</span>, <span class="at">age =</span> <span class="dv">20</span>), <span class="co"># age value = placeholder</span></span>
<span id="cb28-386"><a href="#cb28-386"></a>                    <span class="at">exposed =</span> <span class="cf">function</span>(data) <span class="fu">transform</span>(data, <span class="at">trt =</span> <span class="dv">1</span>, <span class="at">age =</span> <span class="dv">20</span>), <span class="co"># age value = placeholder</span></span>
<span id="cb28-387"><a href="#cb28-387"></a>                    <span class="at">full =</span> <span class="cn">TRUE</span>, <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-388"><a href="#cb28-388"></a><span class="co"># Select relevant columns and rename</span></span>
<span id="cb28-389"><a href="#cb28-389"></a>estimates <span class="ot">&lt;-</span>  estimates <span class="sc">|&gt;</span> </span>
<span id="cb28-390"><a href="#cb28-390"></a>  <span class="fu">select</span>(time, Estimate, lower, upper) <span class="sc">|&gt;</span> </span>
<span id="cb28-391"><a href="#cb28-391"></a>  <span class="fu">rename</span>(<span class="at">Time =</span> time,</span>
<span id="cb28-392"><a href="#cb28-392"></a>         <span class="at">HR =</span> Estimate,</span>
<span id="cb28-393"><a href="#cb28-393"></a>         <span class="st">`</span><span class="at">Lower CI</span><span class="st">`</span> <span class="ot">=</span> lower,</span>
<span id="cb28-394"><a href="#cb28-394"></a>         <span class="st">`</span><span class="at">Upper CI</span><span class="st">`</span> <span class="ot">=</span> upper)</span>
<span id="cb28-395"><a href="#cb28-395"></a>estimates <span class="sc">|&gt;</span> </span>
<span id="cb28-396"><a href="#cb28-396"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb28-397"><a href="#cb28-397"></a><span class="in">```</span></span>
<span id="cb28-398"><a href="#cb28-398"></a></span>
<span id="cb28-399"><a href="#cb28-399"></a>For interest and before we wrap this up, let's superimpose the time-varying HR curves from both the Cox and RP models to enable a more direct comparison.</span>
<span id="cb28-400"><a href="#cb28-400"></a></span>
<span id="cb28-403"><a href="#cb28-403"></a><span class="in">```{r}</span></span>
<span id="cb28-404"><a href="#cb28-404"></a><span class="co">#| message: false</span></span>
<span id="cb28-405"><a href="#cb28-405"></a><span class="co">#| warning: false</span></span>
<span id="cb28-406"><a href="#cb28-406"></a><span class="co"># Tidy RP pred output</span></span>
<span id="cb28-407"><a href="#cb28-407"></a>pred_hrs <span class="ot">&lt;-</span>  pred_hrs <span class="sc">|&gt;</span> </span>
<span id="cb28-408"><a href="#cb28-408"></a>  <span class="fu">select</span>(time, Estimate) <span class="sc">|&gt;</span> </span>
<span id="cb28-409"><a href="#cb28-409"></a>  <span class="fu">slice</span>(<span class="sc">-</span><span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-410"><a href="#cb28-410"></a>  <span class="fu">mutate</span>(<span class="at">Model =</span> <span class="st">"Royston-Parmar"</span>)</span>
<span id="cb28-411"><a href="#cb28-411"></a><span class="co"># Tidy Cox pred output</span></span>
<span id="cb28-412"><a href="#cb28-412"></a>tdata <span class="ot">&lt;-</span>  tdata <span class="sc">|&gt;</span> </span>
<span id="cb28-413"><a href="#cb28-413"></a>  <span class="fu">select</span>(time, fit) <span class="sc">|&gt;</span> </span>
<span id="cb28-414"><a href="#cb28-414"></a>  <span class="fu">slice</span>(<span class="sc">-</span><span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-415"><a href="#cb28-415"></a>  <span class="fu">rename</span>(<span class="at">Estimate =</span> fit) <span class="sc">|&gt;</span> </span>
<span id="cb28-416"><a href="#cb28-416"></a>  <span class="fu">mutate</span>(<span class="at">Model =</span> <span class="st">"Cox"</span>)</span>
<span id="cb28-417"><a href="#cb28-417"></a><span class="co"># Merge both sets of predictions</span></span>
<span id="cb28-418"><a href="#cb28-418"></a>preds_rp_cox <span class="ot">&lt;-</span>  <span class="fu">rbind</span>(pred_hrs, tdata) <span class="sc">|&gt;</span> </span>
<span id="cb28-419"><a href="#cb28-419"></a>  <span class="fu">arrange</span>(time)</span>
<span id="cb28-420"><a href="#cb28-420"></a><span class="co"># Plot</span></span>
<span id="cb28-421"><a href="#cb28-421"></a><span class="fu">ggplot</span>(preds_rp_cox, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> Estimate, <span class="at">color =</span> Model)) <span class="sc">+</span> </span>
<span id="cb28-422"><a href="#cb28-422"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb28-423"><a href="#cb28-423"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">400</span>, <span class="at">by =</span> <span class="dv">50</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">400</span>)) <span class="sc">+</span></span>
<span id="cb28-424"><a href="#cb28-424"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">trans =</span> <span class="st">"log"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">1.5</span>, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb28-425"><a href="#cb28-425"></a>  <span class="fu">xlab</span>(<span class="st">"Observation Time"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"HR for Treatment"</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Time-varying HR for Treatment"</span>) <span class="sc">+</span></span>
<span id="cb28-426"><a href="#cb28-426"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb28-427"><a href="#cb28-427"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>)</span>
<span id="cb28-428"><a href="#cb28-428"></a><span class="in">```</span></span>
<span id="cb28-429"><a href="#cb28-429"></a></span>
<span id="cb28-430"><a href="#cb28-430"></a>Ok, not perfectly congruent, but they both show a similar pattern in that there is an initial increase and then gradual decline in the 'effect' of <span class="in">`trt`</span> over time. Keep in mind that semi- and fully-parametric models are quite different modelling frameworks so the fact that we some concordance in the output gives us more confidence in establishing the validity of our results. I like RP models so much that I will aim to make them the subject of one of these blog posts in the not too distant future.</span>
<span id="cb28-431"><a href="#cb28-431"></a></span>
<span id="cb28-432"><a href="#cb28-432"></a><span class="fu"># Wrap-Up</span></span>
<span id="cb28-433"><a href="#cb28-433"></a></span>
<span id="cb28-434"><a href="#cb28-434"></a>Ok - I'm sure you would agree that you need a break. My apologies if you feel like I've made you run the mental equivalent of a marathon in these last two posts. As you can now see, there is a lot one can potentially cover following the violation of what might appear to be a very simple assumption. Damn you - proportional hazards! Hopefully this has given you some of both knowledge and coding tools that you can put to use when next faced with this common problem in your survival analysis endeavours.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>