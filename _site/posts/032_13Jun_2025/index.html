<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-06-13">
<meta name="description" content="How to Survive Visualising the Cox Model.">

<title>Test Site 2 - Model Prediction/Visualisation  6. Survival Analysis - Cox Model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Test Site 2</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">All Posts</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#visualising-cox-model-predictions---auto-mode" id="toc-visualising-cox-model-predictions---auto-mode" class="nav-link active" data-scroll-target="#visualising-cox-model-predictions---auto-mode"><span class="header-section-number">1</span> Visualising Cox Model Predictions - Auto Mode</a></li>
  <li><a href="#visualising-cox-model-predictions---manual-mode" id="toc-visualising-cox-model-predictions---manual-mode" class="nav-link" data-scroll-target="#visualising-cox-model-predictions---manual-mode"><span class="header-section-number">2</span> Visualising Cox Model Predictions - Manual Mode</a>
  <ul>
  <li><a href="#step-1" id="toc-step-1" class="nav-link" data-scroll-target="#step-1"><span class="header-section-number">2.1</span> Step 1</a></li>
  <li><a href="#step-2" id="toc-step-2" class="nav-link" data-scroll-target="#step-2"><span class="header-section-number">2.2</span> Step 2</a></li>
  <li><a href="#step-3" id="toc-step-3" class="nav-link" data-scroll-target="#step-3"><span class="header-section-number">2.3</span> Step 3</a></li>
  <li><a href="#step-4" id="toc-step-4" class="nav-link" data-scroll-target="#step-4"><span class="header-section-number">2.4</span> Step 4</a></li>
  <li><a href="#step-5" id="toc-step-5" class="nav-link" data-scroll-target="#step-5"><span class="header-section-number">2.5</span> Step 5</a></li>
  </ul></li>
  <li><a href="#end-mode" id="toc-end-mode" class="nav-link" data-scroll-target="#end-mode"><span class="header-section-number">3</span> End Mode</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Model Prediction/Visualisation <br> 6. Survival Analysis - Cox Model</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">code</div>
    <div class="quarto-category">concept</div>
    <div class="quarto-category">modelling</div>
    <div class="quarto-category">visualisation</div>
  </div>
  </div>

<div>
  <div class="description">
    How to Survive Visualising the Cox Model.
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 13, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>In the last post in this series on model prediction and visualisation in <code>R</code> we are going to talk about survival analysis and specifically the Cox model. Like the extensions to the standard linear model that we most recently discussed - the GLM and LMM - predicting with the Cox model is also relatively straightforward, but the intuition in how those predictions are calculated may be less so. I hope to make that easier for you today.</p>
<p>We’re going to use the inbuilt <code>GBSG2</code> dataset form the <code>TH.data</code> package, so please install that package if you don’t already have it. The dataframe contains observations from the German Breast Cancer Study Group 2 study of <code>686</code> women, examining the effects of hormone treatment on recurrence-free survival time. The <a href="https://cran.r-project.org/web/packages/TH.data/TH.data.pdf">variables</a> we’ll be using are:</p>
<ul>
<li><code>time</code> - recurrence free survival time (in days).</li>
<li><code>cens</code> - censoring indicator (0- censored, 1- event).</li>
<li><code>horTh</code> - hormonal therapy, a factor at two levels (yes and no).</li>
<li><code>tsize</code> - tumor size (in mm).</li>
</ul>
<p>The first few rows of the data look like:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(survminer)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(gtsummary)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co"># Load data</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="fu">data</span>(GBSG2, <span class="at">package =</span> <span class="st">"TH.data"</span>)</span>
<span id="cb1-8"><a href="#cb1-8"></a>GBSG2 <span class="sc">|&gt;</span> </span>
<span id="cb1-9"><a href="#cb1-9"></a>  <span class="fu">select</span>(time, cens, horTh, tsize) <span class="sc">|&gt;</span> </span>
<span id="cb1-10"><a href="#cb1-10"></a>  <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-11"><a href="#cb1-11"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">time</th>
<th style="text-align: center;">cens</th>
<th style="text-align: center;">horTh</th>
<th style="text-align: center;">tsize</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1814</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">21</td>
</tr>
<tr class="even">
<td style="text-align: center;">2018</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">yes</td>
<td style="text-align: center;">12</td>
</tr>
<tr class="odd">
<td style="text-align: center;">712</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">yes</td>
<td style="text-align: center;">35</td>
</tr>
<tr class="even">
<td style="text-align: center;">1807</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">yes</td>
<td style="text-align: center;">17</td>
</tr>
<tr class="odd">
<td style="text-align: center;">772</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">35</td>
</tr>
<tr class="even">
<td style="text-align: center;">448</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">57</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2172</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">yes</td>
<td style="text-align: center;">8</td>
</tr>
<tr class="even">
<td style="text-align: center;">2161</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">16</td>
</tr>
<tr class="odd">
<td style="text-align: center;">471</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">39</td>
</tr>
<tr class="even">
<td style="text-align: center;">2014</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">18</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><br></p>
<p>The first thing we can do is to plot the empirical survival curve by calling on the Kaplan-Meier estimator - stratifying this by whether a woman received hormone therapy or not.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Kaplan-Meier fit</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, cens) <span class="sc">~</span> horTh, <span class="at">data =</span> GBSG2)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co"># Plot KM fit</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="fu">ggsurvplot</span>(fit, </span>
<span id="cb2-5"><a href="#cb2-5"></a>           <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-6"><a href="#cb2-6"></a>           <span class="at">submain =</span> <span class="st">"Kaplan-Meier Survival Curves for Hormone Therapy Use"</span>) <span class="sc">+</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>  <span class="fu">theme_survminer</span>(</span>
<span id="cb2-8"><a href="#cb2-8"></a>     <span class="at">font.submain =</span> <span class="dv">22</span>,</span>
<span id="cb2-9"><a href="#cb2-9"></a>     <span class="at">font.x =</span> <span class="dv">18</span>,</span>
<span id="cb2-10"><a href="#cb2-10"></a>     <span class="at">font.y =</span> <span class="dv">18</span>,</span>
<span id="cb2-11"><a href="#cb2-11"></a>     <span class="at">font.legend =</span> <span class="dv">16</span>,</span>
<span id="cb2-12"><a href="#cb2-12"></a>     <span class="at">font.tickslab =</span> <span class="dv">14</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>It appears that unadjusted for other potentially confounding factors, women who take hormone therapy have a better chance of survival - an unsurprising finding I’m sure you would agree.</p>
<p>Let’s fit a Cox model to the data, now also adjusting for tumour size.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>cox_mod <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, cens) <span class="sc">~</span> horTh <span class="sc">+</span> tsize, <span class="at">data =</span> GBSG2)</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="fu">tbl_regression</span>(cox_mod, <span class="at">exp =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="zsuwpfldnk" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#zsuwpfldnk table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#zsuwpfldnk thead, #zsuwpfldnk tbody, #zsuwpfldnk tfoot, #zsuwpfldnk tr, #zsuwpfldnk td, #zsuwpfldnk th {
  border-style: none;
}

#zsuwpfldnk p {
  margin: 0;
  padding: 0;
}

#zsuwpfldnk .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#zsuwpfldnk .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#zsuwpfldnk .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#zsuwpfldnk .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#zsuwpfldnk .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zsuwpfldnk .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zsuwpfldnk .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zsuwpfldnk .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#zsuwpfldnk .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#zsuwpfldnk .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#zsuwpfldnk .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#zsuwpfldnk .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#zsuwpfldnk .gt_spanner_row {
  border-bottom-style: hidden;
}

#zsuwpfldnk .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#zsuwpfldnk .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#zsuwpfldnk .gt_from_md > :first-child {
  margin-top: 0;
}

#zsuwpfldnk .gt_from_md > :last-child {
  margin-bottom: 0;
}

#zsuwpfldnk .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#zsuwpfldnk .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#zsuwpfldnk .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#zsuwpfldnk .gt_row_group_first td {
  border-top-width: 2px;
}

#zsuwpfldnk .gt_row_group_first th {
  border-top-width: 2px;
}

#zsuwpfldnk .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zsuwpfldnk .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#zsuwpfldnk .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#zsuwpfldnk .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zsuwpfldnk .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zsuwpfldnk .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#zsuwpfldnk .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#zsuwpfldnk .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#zsuwpfldnk .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zsuwpfldnk .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zsuwpfldnk .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zsuwpfldnk .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zsuwpfldnk .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zsuwpfldnk .gt_left {
  text-align: left;
}

#zsuwpfldnk .gt_center {
  text-align: center;
}

#zsuwpfldnk .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#zsuwpfldnk .gt_font_normal {
  font-weight: normal;
}

#zsuwpfldnk .gt_font_bold {
  font-weight: bold;
}

#zsuwpfldnk .gt_font_italic {
  font-style: italic;
}

#zsuwpfldnk .gt_super {
  font-size: 65%;
}

#zsuwpfldnk .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#zsuwpfldnk .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#zsuwpfldnk .gt_indent_1 {
  text-indent: 5px;
}

#zsuwpfldnk .gt_indent_2 {
  text-indent: 10px;
}

#zsuwpfldnk .gt_indent_3 {
  text-indent: 15px;
}

#zsuwpfldnk .gt_indent_4 {
  text-indent: 20px;
}

#zsuwpfldnk .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header gt_col_headings">
<th id="<strong>Characteristic</strong>" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col"><strong>Characteristic</strong></th>
<th id="<strong>HR</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>HR</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
<th id="<strong>95% CI</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>95% CI</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
<th id="<strong>p-value</strong>" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>p-value</strong></th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="label">horTh</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="ci"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;no</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="ci">—</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;yes</td>
<td class="gt_row gt_center" headers="estimate">0.69</td>
<td class="gt_row gt_center" headers="ci">0.54, 0.88</td>
<td class="gt_row gt_center" headers="p.value">0.003</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">tsize</td>
<td class="gt_row gt_center" headers="estimate">1.02</td>
<td class="gt_row gt_center" headers="ci">1.01, 1.02</td>
<td class="gt_row gt_center" headers="p.value">&lt;0.001</td>
</tr>
</tbody><tfoot class="gt_footnotes">
<tr class="odd">
<td colspan="4" class="gt_footnote"><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span> HR = Hazard Ratio, CI = Confidence Interval</td>
</tr>
</tfoot>

</table>

</div>
</div>
</div>
<p>The model results suggest (in agreement with the KM curve) that holding tumour size constant, there is an ~ <code>31%</code> reduction in the risk of recurrence for women who take hormone therapy. Similarly, within strata of hormone therapy, each additional mm increase in tumour size is associated with an ~ <code>2%</code> increase in the risk of recurrence over time.</p>
<section id="visualising-cox-model-predictions---auto-mode" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Visualising Cox Model Predictions - Auto Mode</h1>
<p>Let’s say we are now interested in predicting survival as a function of both hormone therapy use and tumour size. Well we can just call <code>predict()</code> on our Cox model, specifying a new grid of data to predict on, which at minimum must include our time and status (which we set to <code>1</code>) variables. In addition I have asked to predict survival for four covariate combinations (tumour sizes of <code>3</code> and <code>120</code> mm are the minimum and maximum values in the dataset):</p>
<ol type="1">
<li>hormone therapy = <code>no  (0)</code> and tumour size = <code>3</code> mm</li>
<li>hormone therapy = <code>yes (1)</code> and tumour size = <code>3</code> mm</li>
<li>hormone therapy = <code>no  (0)</code> and tumour size = <code>120</code> mm</li>
<li>hormone therapy = <code>yes (1)</code> and tumour size = <code>120</code> mm</li>
</ol>
<p>Note that we need to make one small tweak in <code>predict()</code> which is to include an argument for prediction type - in this case we want <strong>“survival”</strong> (note there are <a href="https://stat.ethz.ch/R-manual/R-devel/library/survival/html/predict.coxph.html">additional types</a> that you can specify depending on what you want to predict from the model).</p>
<p>The code to do this is shown below. The reason I’m calling this “auto mode” is that there’s really nothing different here to what we have done so far - we pretty much just let predict handle everything.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># Create new data grid to predict on</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>newdat <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">time =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">2500</span>, <span class="at">by =</span> <span class="dv">50</span>), </span>
<span id="cb4-3"><a href="#cb4-3"></a>                      <span class="at">cens =</span> <span class="dv">1</span>, </span>
<span id="cb4-4"><a href="#cb4-4"></a>                      <span class="at">horTh =</span> <span class="fu">levels</span>(GBSG2<span class="sc">$</span>horTh),</span>
<span id="cb4-5"><a href="#cb4-5"></a>                      <span class="at">tsize =</span> <span class="fu">c</span>(<span class="fu">min</span>(GBSG2<span class="sc">$</span>tsize), <span class="fu">max</span>(GBSG2<span class="sc">$</span>tsize)))</span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co"># Calculate predicted survival probabilities</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(cox_mod, <span class="at">newdata =</span> newdat, <span class="at">type =</span> <span class="st">"survival"</span>, <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-8"><a href="#cb4-8"></a>newdat<span class="sc">$</span>prob_surv <span class="ot">&lt;-</span> preds<span class="sc">$</span>fit</span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co"># If wanting to calculate 95% C.I.'s...</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>newdat<span class="sc">$</span>lcl_surv <span class="ot">&lt;-</span> preds<span class="sc">$</span>fit <span class="sc">-</span> <span class="fl">1.96</span><span class="sc">*</span>preds<span class="sc">$</span>se.fit</span>
<span id="cb4-11"><a href="#cb4-11"></a>newdat<span class="sc">$</span>ucl_surv <span class="ot">&lt;-</span> preds<span class="sc">$</span>fit <span class="sc">+</span> <span class="fl">1.96</span><span class="sc">*</span>preds<span class="sc">$</span>se.fit</span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co"># View predictions</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="fu">head</span>(newdat, <span class="dv">10</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-14"><a href="#cb4-14"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">time</th>
<th style="text-align: center;">cens</th>
<th style="text-align: center;">horTh</th>
<th style="text-align: center;">tsize</th>
<th style="text-align: center;">prob_surv</th>
<th style="text-align: center;">lcl_surv</th>
<th style="text-align: center;">ucl_surv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
<td style="text-align: center;">1.0000</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">50</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
<td style="text-align: center;">1.0000</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">100</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9978</td>
<td style="text-align: center;">0.9948</td>
<td style="text-align: center;">1.0009</td>
</tr>
<tr class="even">
<td style="text-align: center;">150</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9956</td>
<td style="text-align: center;">0.9913</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">200</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9823</td>
<td style="text-align: center;">0.9730</td>
<td style="text-align: center;">0.9917</td>
</tr>
<tr class="even">
<td style="text-align: center;">250</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9723</td>
<td style="text-align: center;">0.9600</td>
<td style="text-align: center;">0.9845</td>
</tr>
<tr class="odd">
<td style="text-align: center;">300</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9599</td>
<td style="text-align: center;">0.9445</td>
<td style="text-align: center;">0.9753</td>
</tr>
<tr class="even">
<td style="text-align: center;">350</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9439</td>
<td style="text-align: center;">0.9248</td>
<td style="text-align: center;">0.9630</td>
</tr>
<tr class="odd">
<td style="text-align: center;">400</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9231</td>
<td style="text-align: center;">0.8994</td>
<td style="text-align: center;">0.9468</td>
</tr>
<tr class="even">
<td style="text-align: center;">450</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9079</td>
<td style="text-align: center;">0.8810</td>
<td style="text-align: center;">0.9347</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><br></p>
<p>And then we can plot the predictions like so using <code>ggplot</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># Create 'labeller' for tumour size</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>tum_names <span class="ot">&lt;-</span> <span class="fu">as_labeller</span>(</span>
<span id="cb5-3"><a href="#cb5-3"></a>     <span class="fu">c</span>(<span class="st">`</span><span class="at">3</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Tumour Size = 3 mm"</span>, <span class="st">`</span><span class="at">120</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Tumour Size = 120 mm"</span>))</span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co"># Plot</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="fu">ggplot</span>(newdat, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> prob_surv, <span class="at">color =</span> horTh)) <span class="sc">+</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>  <span class="fu">facet_wrap</span>(tsize <span class="sc">~</span> ., <span class="at">labeller =</span> tum_names) <span class="sc">+</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Recurrence-Free Survival (Days)"</span>,</span>
<span id="cb5-10"><a href="#cb5-10"></a>       <span class="at">y =</span> <span class="st">"Predicted Probability of Survival"</span>,</span>
<span id="cb5-11"><a href="#cb5-11"></a>       <span class="at">title =</span> <span class="st">"Probability of Survival as a Function of Hormone Therapy and Tumour Size"</span>,</span>
<span id="cb5-12"><a href="#cb5-12"></a>       <span class="at">color =</span> <span class="st">"Hormone Therapy"</span>) <span class="sc">+</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>These visualisations confirm our intuition that survival is better for women with smaller tumours and who also take hormone therapy to manage their disease.</p>
</section>
<section id="visualising-cox-model-predictions---manual-mode" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Visualising Cox Model Predictions - Manual Mode</h1>
<p>Ultimately, what I have described above is all you need to know if you want to visualise predictions from the Cox model. But if you are interested in understanding at a deeper level how the predicted values are calculated, I’ll also take you through “manual mode”.</p>
<p>An important first point to grasp is that estimation of the baseline hazard function is essential to predicting survival probabilities in time-to-event models. You can think of the baseline hazard function as the equivalent of the intercept in a standard linear model. These provide an <strong>absolute</strong> value of the outcome from which <strong>relative</strong> ‘effect’ estimates are computed. For example, the hazard ratio in a Cox model represents a proportional change in the hazard rate for one covariate category (e.g.&nbsp;hormone therapy = yes [coded as 1]) relative to a reference covariate category (e.g.&nbsp;hormone therapy = no [coded as 0]) which is assumed to take the shape of the baseline hazard rate function. The baseline hazard rate itself can vary over time, but the proportional change should remain the same (if the proportional hazards assumption is satisfied). I have briefly touched on these ideas in a <a href="https://msni-stats-tips.netlify.app/posts/021_01nov_2024/#semi-parametric-cox-model">previous post</a>. The comparison with the linear model is in the regression coefficient representing a relative average change from the model intercept, which if you recall is the mean value of the outcome when all covariate values are at <code>0</code> or at their reference level. Similarly, the baseline hazard rate function is referred to as <em>baseline</em> because it represents the hazard rate function when all covariate values are at <code>0</code> or at their reference level.</p>
<p>Now, while fully-parametric survival models assume a particular statistical distribution for the baseline hazard rate and estimate it by default, the semi-parametric nature of the Cox model allows hazard ratios to be computed without any knowledge of the function. Consequently, we cannot directly obtain survival probabilities from it, but we can do a little post-hoc “under-the-hood” processing to combine it with a non-parametric estimator of the baseline hazard function (typically the <strong>Breslow</strong> estimator) - and estimate survival probabilities that way.</p>
<p>In <code>R</code> we can use the <a href="https://stat.ethz.ch/R-manual/R-devel/library/survival/html/basehaz.html"><code>basehaz()</code></a> function to calculate the <strong>cumulative</strong> baseline hazard function <code>H(t)</code>. This is different to the baseline hazard rate function that we have discussed until now. The cumulative baseline hazard function represents the integral of the baseline hazard rate function from <code>0</code> to <code>t</code>, and can be thought of as the total accumulated risk of experiencing the event of interest by time <code>t</code>. Because it is more computationally stable to work with, <code>H(t)</code> acts as a useful link in deriving survival probabilities from hazard rates. Once we know the cumulative baseline hazard function, it’s very easy to find the commensurate survival function <code>S(t)</code> (the probability that the event of interest has not occurred by time <code>t</code>) by simply exponentiating the negative of <code>H(t)</code> - i.e.:</p>
<p><span class="math display">\[ S(t) = e^{-H(t)} \]</span> More detail can be found <a href="https://www.graphpad.com/guides/prism/latest/statistics/stat_cox_math_cumulative_hazard.htm">here</a>.</p>
<p>Let’s now put this process into action with the existing data. We can essentially break this down into five steps which I have labelled accordingly in the code below to help you follow the description:</p>
<section id="step-1" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="step-1"><span class="header-section-number">2.1</span> Step 1</h2>
<p>The first thing we need to do is to estimate the cumulative baseline hazard function (<code>H0</code>) when all covariate values are at <code>0</code> or at their reference level. We do this using specifying <code>centered = FALSE</code> in the call to <code>basehaz()</code>. It is important to include the <code>centered = F</code> argument as the default setting is <code>TRUE</code> which we don’t want as this has a different interpretation (i.e.&nbsp;cumulative hazard function estimated at the mean of all covariate values). Also note that the cumulative hazard is estimated at each of the <em>observed</em> times in the dataset.</p>
</section>
<section id="step-2" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="step-2"><span class="header-section-number">2.2</span> Step 2</h2>
<p>We then estimate the cumulative hazard function (<code>H1</code> - <code>H4</code>) for each covariate combination of interest. For these data we have four as I have listed above. As an example, to calculate <code>H1</code> we simply multiply <code>H0</code> by the covariate combination values and their respective Cox model coefficients. e.g.:</p>
<p><code>H1 &lt;- H0$hazard * exp((0 * cox_mod$coefficients[1]) + (3 * cox_mod$coefficients[2]))</code></p>
<p>In the above <code>cox_mod$coefficients[1]</code> gives the coefficient value for hormone therapy and <code>cox_mod$coefficients[2]</code> gives the coefficient value for tumour size. To obtain the cumulative hazard function for the first covariate combination we just multiply the cumulative baseline hazard function by the exponent of the sum of the products of the coefficients and our covariate values of interest (in this case <code>0</code> to indicate no hormone therapy and <code>3</code> to indicate the tumour size).</p>
</section>
<section id="step-3" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="step-3"><span class="header-section-number">2.3</span> Step 3</h2>
<p>We then calculate the survival function for each covariate combination by taking the exponent of the negative of the cumulative hazard function.</p>
</section>
<section id="step-4" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="step-4"><span class="header-section-number">2.4</span> Step 4</h2>
<p>Now we create a dataframe containing the predicted survival probabilities for each covariate combination. The first <code>20</code> rows for each covariate combination is shown below.</p>
</section>
<section id="step-5" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="step-5"><span class="header-section-number">2.5</span> Step 5</h2>
<p>Then we create our plot.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># Step 1</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co"># Estimate the cumulative baseline hazard function</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>H0 <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(cox_mod, <span class="at">centered =</span> F)</span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co"># Step 2</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co"># Calculate cumulative hazard function for covariate combo 1.</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>H1 <span class="ot">&lt;-</span> H0<span class="sc">$</span>hazard <span class="sc">*</span> <span class="fu">exp</span>((<span class="dv">0</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">1</span>]) <span class="sc">+</span> (<span class="dv">3</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">2</span>]))</span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co"># Calculate cumulative hazard function for covariate combo 2.</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>H2 <span class="ot">&lt;-</span> H0<span class="sc">$</span>hazard <span class="sc">*</span> <span class="fu">exp</span>((<span class="dv">1</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">1</span>]) <span class="sc">+</span> (<span class="dv">3</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">2</span>]))</span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="co"># Calculate cumulative hazard function for covariate combo 3.</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>H3 <span class="ot">&lt;-</span> H0<span class="sc">$</span>hazard <span class="sc">*</span> <span class="fu">exp</span>((<span class="dv">0</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">1</span>]) <span class="sc">+</span> (<span class="dv">120</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">2</span>]))</span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co"># Calculate cumulative hazard function for covariate combo 4.</span></span>
<span id="cb6-13"><a href="#cb6-13"></a>H4 <span class="ot">&lt;-</span> H0<span class="sc">$</span>hazard <span class="sc">*</span> <span class="fu">exp</span>((<span class="dv">1</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">1</span>]) <span class="sc">+</span> (<span class="dv">120</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">2</span>]))</span>
<span id="cb6-14"><a href="#cb6-14"></a></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co"># Step 3</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="co"># Calculate survival function for covariate combo 1.</span></span>
<span id="cb6-17"><a href="#cb6-17"></a>S1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>H1)</span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="co"># Calculate survival function for covariate combo 2.</span></span>
<span id="cb6-19"><a href="#cb6-19"></a>S2 <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>H2)</span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="co"># Calculate survival function for covariate combo 3.</span></span>
<span id="cb6-21"><a href="#cb6-21"></a>S3 <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>H3)</span>
<span id="cb6-22"><a href="#cb6-22"></a><span class="co"># Calculate survival function for covariate combo 4.</span></span>
<span id="cb6-23"><a href="#cb6-23"></a>S4 <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>H4)</span>
<span id="cb6-24"><a href="#cb6-24"></a></span>
<span id="cb6-25"><a href="#cb6-25"></a><span class="co"># Step 4</span></span>
<span id="cb6-26"><a href="#cb6-26"></a><span class="co"># Create dataframe of predicted survival probabilities as a function of covariate combos</span></span>
<span id="cb6-27"><a href="#cb6-27"></a>surv_df <span class="ot">&lt;-</span>  <span class="fu">rbind</span>(<span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">1</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">0</span>, <span class="at">tsize =</span> <span class="dv">3</span>, <span class="at">prob_surv =</span> S1),</span>
<span id="cb6-28"><a href="#cb6-28"></a>                  <span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">2</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">1</span>, <span class="at">tsize =</span> <span class="dv">3</span>, <span class="at">prob_surv =</span> S2),</span>
<span id="cb6-29"><a href="#cb6-29"></a>                  <span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">3</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">0</span>, <span class="at">tsize =</span> <span class="dv">120</span>, <span class="at">prob_surv =</span> S3),</span>
<span id="cb6-30"><a href="#cb6-30"></a>                  <span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">4</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">1</span>, <span class="at">tsize =</span> <span class="dv">120</span>, <span class="at">prob_surv =</span> S4))</span>
<span id="cb6-31"><a href="#cb6-31"></a></span>
<span id="cb6-32"><a href="#cb6-32"></a><span class="co"># Inspect each df</span></span>
<span id="cb6-33"><a href="#cb6-33"></a><span class="fu">head</span>(<span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">1</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">0</span>, <span class="at">tsize =</span> <span class="dv">3</span>, <span class="at">prob_surv =</span> S1), <span class="dv">20</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-34"><a href="#cb6-34"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">combo</th>
<th style="text-align: center;">time</th>
<th style="text-align: center;">horTh</th>
<th style="text-align: center;">tsize</th>
<th style="text-align: center;">prob_surv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">15</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">16</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">17</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">18</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">29</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">42</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">46</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">57</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">63</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">65</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">67</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">71</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9989</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">98</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9978</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">113</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9967</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">114</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9967</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9956</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">148</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9956</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">160</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9945</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">head</span>(<span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">2</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">1</span>, <span class="at">tsize =</span> <span class="dv">3</span>, <span class="at">prob_surv =</span> S2), <span class="dv">20</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">combo</th>
<th style="text-align: center;">time</th>
<th style="text-align: center;">horTh</th>
<th style="text-align: center;">tsize</th>
<th style="text-align: center;">prob_surv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">15</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">16</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">17</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">18</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">29</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">42</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">46</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">57</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">63</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">65</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">67</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">71</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9992</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">98</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9985</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">113</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9977</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">114</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9977</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9970</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">148</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9970</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">160</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.9962</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">head</span>(<span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">3</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">0</span>, <span class="at">tsize =</span> <span class="dv">120</span>, <span class="at">prob_surv =</span> S3), <span class="dv">20</span>) <span class="sc">|&gt;</span> </span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">combo</th>
<th style="text-align: center;">time</th>
<th style="text-align: center;">horTh</th>
<th style="text-align: center;">tsize</th>
<th style="text-align: center;">prob_surv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">15</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">16</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">17</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">18</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">29</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">42</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">46</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">57</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">63</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">65</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">67</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">71</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0.9935</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">98</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0.9871</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">113</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0.9807</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">114</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0.9807</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0.9743</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">148</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0.9743</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">160</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0.9679</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">head</span>(<span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">4</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">1</span>, <span class="at">tsize =</span> <span class="dv">120</span>, <span class="at">prob_surv =</span> S4), <span class="dv">20</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">combo</th>
<th style="text-align: center;">time</th>
<th style="text-align: center;">horTh</th>
<th style="text-align: center;">tsize</th>
<th style="text-align: center;">prob_surv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">15</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">16</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">17</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">18</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">29</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">42</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">46</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">57</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">63</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">65</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">67</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">71</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1.0000</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0.9955</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">98</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0.9911</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">113</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0.9867</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">114</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0.9867</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0.9822</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">148</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0.9822</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">160</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">0.9778</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><br></p>
<p>…and Voilà.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># Step 5</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co"># Create 'labeller' for tumour size</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>tum_names <span class="ot">&lt;-</span> <span class="fu">as_labeller</span>(</span>
<span id="cb10-4"><a href="#cb10-4"></a>  <span class="fu">c</span>(<span class="st">`</span><span class="at">3</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Tumour Size = 3 mm"</span>, <span class="st">`</span><span class="at">120</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Tumour Size = 120 mm"</span>))</span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="co"># Plot</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="fu">ggplot</span>(surv_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> prob_surv, <span class="at">color =</span> <span class="fu">factor</span>(horTh))) <span class="sc">+</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>  <span class="fu">facet_wrap</span>(tsize <span class="sc">~</span> ., <span class="at">labeller =</span> tum_names) <span class="sc">+</span></span>
<span id="cb10-9"><a href="#cb10-9"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Recurrence-Free Survival (Days)"</span>,</span>
<span id="cb10-11"><a href="#cb10-11"></a>       <span class="at">y =</span> <span class="st">"Predicted Probability of Survival"</span>,</span>
<span id="cb10-12"><a href="#cb10-12"></a>       <span class="at">title =</span> <span class="st">"Probability of Survival as a Function of Hormone Therapy and Tumour Size"</span>,</span>
<span id="cb10-13"><a href="#cb10-13"></a>       <span class="at">color =</span> <span class="st">"Hormone Therapy"</span>) <span class="sc">+</span></span>
<span id="cb10-14"><a href="#cb10-14"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="end-mode" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> End Mode</h1>
<p>That brings us to an end in this series on model prediction and visualisation in <code>R</code>. I hope it’s given you some appreciation for how much further you can take your regression modelling endeavours. I find being able to ‘see’ what my model is proposing as a reflection of reality to be an invaluable addition to the simply listing of a bunch of coefficient values that we tend to take as the final product of model estimation. We don’t need to - and in fact we shouldn’t - stop there. You are familiar with the statistical adage of ‘always plot your data’. Well, in becoming a better data analyst I think a similar argument could be made for ‘always plot your models’.</p>
<p>Until next time…</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="pgseye/Weekly_Stats_Tips" data-repo-id="R_kgDOKvfOfQ" data-category="General" data-category-id="DIC_kwDOKvfOfc4CbFWq" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb11" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb11-1"><a href="#cb11-1"></a><span class="co">---</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="an">title:</span><span class="co"> "Model Prediction/Visualisation &lt;br&gt; 6. Survival Analysis - Cox Model"</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="an">date:</span><span class="co"> 2025-06-13</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="an">categories:</span><span class="co"> [code, concept, modelling, visualisation]</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="co"># image: "images/plot.png"</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="an">description:</span><span class="co"> "How to Survive Visualising the Cox Model."</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="co">---</span></span>
<span id="cb11-8"><a href="#cb11-8"></a></span>
<span id="cb11-9"><a href="#cb11-9"></a>In the last post in this series on model prediction and visualisation in <span class="in">`R`</span> we are going to talk about survival analysis and specifically the Cox model. Like the extensions to the standard linear model that we most recently discussed - the GLM and LMM - predicting with the Cox model is also relatively straightforward, but the intuition in how those predictions are calculated may be less so. I hope to make that easier for you today.</span>
<span id="cb11-10"><a href="#cb11-10"></a></span>
<span id="cb11-11"><a href="#cb11-11"></a>We're going to use the inbuilt <span class="in">`GBSG2`</span> dataset form the <span class="in">`TH.data`</span> package, so please install that package if you don't already have it. The dataframe contains observations from the German Breast Cancer Study Group 2 study of <span class="in">`686`</span> women, examining the effects of hormone treatment on recurrence-free survival time. The <span class="co">[</span><span class="ot">variables</span><span class="co">](https://cran.r-project.org/web/packages/TH.data/TH.data.pdf)</span> we'll be using are:</span>
<span id="cb11-12"><a href="#cb11-12"></a></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="ss">-   </span><span class="in">`time`</span> - recurrence free survival time (in days).</span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="ss">-   </span><span class="in">`cens`</span> - censoring indicator (0- censored, 1- event).</span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="ss">-   </span><span class="in">`horTh`</span> - hormonal therapy, a factor at two levels (yes and no).</span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="ss">-   </span><span class="in">`tsize`</span> - tumor size (in mm).</span>
<span id="cb11-17"><a href="#cb11-17"></a></span>
<span id="cb11-18"><a href="#cb11-18"></a>The first few rows of the data look like:</span>
<span id="cb11-19"><a href="#cb11-19"></a></span>
<span id="cb11-22"><a href="#cb11-22"></a><span class="in">```{r}</span></span>
<span id="cb11-23"><a href="#cb11-23"></a><span class="co">#| message: false</span></span>
<span id="cb11-24"><a href="#cb11-24"></a><span class="co">#| warning: false</span></span>
<span id="cb11-25"><a href="#cb11-25"></a><span class="fu">library</span>(survival)</span>
<span id="cb11-26"><a href="#cb11-26"></a><span class="fu">library</span>(survminer)</span>
<span id="cb11-27"><a href="#cb11-27"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb11-28"><a href="#cb11-28"></a><span class="fu">library</span>(gtsummary)</span>
<span id="cb11-29"><a href="#cb11-29"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb11-30"><a href="#cb11-30"></a><span class="co"># Load data</span></span>
<span id="cb11-31"><a href="#cb11-31"></a><span class="fu">data</span>(GBSG2, <span class="at">package =</span> <span class="st">"TH.data"</span>)</span>
<span id="cb11-32"><a href="#cb11-32"></a>GBSG2 <span class="sc">|&gt;</span> </span>
<span id="cb11-33"><a href="#cb11-33"></a>  <span class="fu">select</span>(time, cens, horTh, tsize) <span class="sc">|&gt;</span> </span>
<span id="cb11-34"><a href="#cb11-34"></a>  <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-35"><a href="#cb11-35"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb11-36"><a href="#cb11-36"></a><span class="in">```</span></span>
<span id="cb11-37"><a href="#cb11-37"></a></span>
<span id="cb11-38"><a href="#cb11-38"></a>&lt;br&gt;</span>
<span id="cb11-39"><a href="#cb11-39"></a></span>
<span id="cb11-40"><a href="#cb11-40"></a>The first thing we can do is to plot the empirical survival curve by calling on the Kaplan-Meier estimator - stratifying this by whether a woman received hormone therapy or not.</span>
<span id="cb11-41"><a href="#cb11-41"></a></span>
<span id="cb11-44"><a href="#cb11-44"></a><span class="in">```{r}</span></span>
<span id="cb11-45"><a href="#cb11-45"></a><span class="co"># Kaplan-Meier fit</span></span>
<span id="cb11-46"><a href="#cb11-46"></a>fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, cens) <span class="sc">~</span> horTh, <span class="at">data =</span> GBSG2)</span>
<span id="cb11-47"><a href="#cb11-47"></a><span class="co"># Plot KM fit</span></span>
<span id="cb11-48"><a href="#cb11-48"></a><span class="fu">ggsurvplot</span>(fit, </span>
<span id="cb11-49"><a href="#cb11-49"></a>           <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb11-50"><a href="#cb11-50"></a>           <span class="at">submain =</span> <span class="st">"Kaplan-Meier Survival Curves for Hormone Therapy Use"</span>) <span class="sc">+</span></span>
<span id="cb11-51"><a href="#cb11-51"></a>  <span class="fu">theme_survminer</span>(</span>
<span id="cb11-52"><a href="#cb11-52"></a>     <span class="at">font.submain =</span> <span class="dv">22</span>,</span>
<span id="cb11-53"><a href="#cb11-53"></a>     <span class="at">font.x =</span> <span class="dv">18</span>,</span>
<span id="cb11-54"><a href="#cb11-54"></a>     <span class="at">font.y =</span> <span class="dv">18</span>,</span>
<span id="cb11-55"><a href="#cb11-55"></a>     <span class="at">font.legend =</span> <span class="dv">16</span>,</span>
<span id="cb11-56"><a href="#cb11-56"></a>     <span class="at">font.tickslab =</span> <span class="dv">14</span>)</span>
<span id="cb11-57"><a href="#cb11-57"></a><span class="in">```</span></span>
<span id="cb11-58"><a href="#cb11-58"></a></span>
<span id="cb11-59"><a href="#cb11-59"></a>It appears that unadjusted for other potentially confounding factors, women who take hormone therapy have a better chance of survival - an unsurprising finding I'm sure you would agree.</span>
<span id="cb11-60"><a href="#cb11-60"></a></span>
<span id="cb11-61"><a href="#cb11-61"></a>Let's fit a Cox model to the data, now also adjusting for tumour size.</span>
<span id="cb11-62"><a href="#cb11-62"></a></span>
<span id="cb11-65"><a href="#cb11-65"></a><span class="in">```{r}</span></span>
<span id="cb11-66"><a href="#cb11-66"></a>cox_mod <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, cens) <span class="sc">~</span> horTh <span class="sc">+</span> tsize, <span class="at">data =</span> GBSG2)</span>
<span id="cb11-67"><a href="#cb11-67"></a><span class="fu">tbl_regression</span>(cox_mod, <span class="at">exp =</span> T)</span>
<span id="cb11-68"><a href="#cb11-68"></a><span class="in">```</span></span>
<span id="cb11-69"><a href="#cb11-69"></a></span>
<span id="cb11-70"><a href="#cb11-70"></a>The model results suggest (in agreement with the KM curve) that holding tumour size constant, there is an \~ <span class="in">`31%`</span> reduction in the risk of recurrence for women who take hormone therapy. Similarly, within strata of hormone therapy, each additional mm increase in tumour size is associated with an \~ <span class="in">`2%`</span> increase in the risk of recurrence over time.</span>
<span id="cb11-71"><a href="#cb11-71"></a></span>
<span id="cb11-72"><a href="#cb11-72"></a><span class="fu"># Visualising Cox Model Predictions - Auto Mode</span></span>
<span id="cb11-73"><a href="#cb11-73"></a></span>
<span id="cb11-74"><a href="#cb11-74"></a>Let's say we are now interested in predicting survival as a function of both hormone therapy use and tumour size. Well we can just call <span class="in">`predict()`</span> on our Cox model, specifying a new grid of data to predict on, which at minimum must include our time and status (which we set to <span class="in">`1`</span>) variables. In addition I have asked to predict survival for four covariate combinations (tumour sizes of <span class="in">`3`</span> and <span class="in">`120`</span> mm are the minimum and maximum values in the dataset):</span>
<span id="cb11-75"><a href="#cb11-75"></a></span>
<span id="cb11-76"><a href="#cb11-76"></a><span class="ss">1.  </span>hormone therapy = <span class="in">`no  (0)`</span> and tumour size = <span class="in">`3`</span> mm</span>
<span id="cb11-77"><a href="#cb11-77"></a><span class="ss">2.  </span>hormone therapy = <span class="in">`yes (1)`</span> and tumour size = <span class="in">`3`</span> mm</span>
<span id="cb11-78"><a href="#cb11-78"></a><span class="ss">3.  </span>hormone therapy = <span class="in">`no  (0)`</span> and tumour size = <span class="in">`120`</span> mm</span>
<span id="cb11-79"><a href="#cb11-79"></a><span class="ss">4.  </span>hormone therapy = <span class="in">`yes (1)`</span> and tumour size = <span class="in">`120`</span> mm</span>
<span id="cb11-80"><a href="#cb11-80"></a></span>
<span id="cb11-81"><a href="#cb11-81"></a>Note that we need to make one small tweak in <span class="in">`predict()`</span> which is to include an argument for prediction type - in this case we want **"survival"** (note there are <span class="co">[</span><span class="ot">additional types</span><span class="co">](https://stat.ethz.ch/R-manual/R-devel/library/survival/html/predict.coxph.html)</span> that you can specify depending on what you want to predict from the model).</span>
<span id="cb11-82"><a href="#cb11-82"></a></span>
<span id="cb11-83"><a href="#cb11-83"></a>The code to do this is shown below. The reason I'm calling this "auto mode" is that there's really nothing different here to what we have done so far - we pretty much just let predict handle everything.</span>
<span id="cb11-84"><a href="#cb11-84"></a></span>
<span id="cb11-87"><a href="#cb11-87"></a><span class="in">```{r}</span></span>
<span id="cb11-88"><a href="#cb11-88"></a><span class="co"># Create new data grid to predict on</span></span>
<span id="cb11-89"><a href="#cb11-89"></a>newdat <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">time =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">2500</span>, <span class="at">by =</span> <span class="dv">50</span>), </span>
<span id="cb11-90"><a href="#cb11-90"></a>                      <span class="at">cens =</span> <span class="dv">1</span>, </span>
<span id="cb11-91"><a href="#cb11-91"></a>                      <span class="at">horTh =</span> <span class="fu">levels</span>(GBSG2<span class="sc">$</span>horTh),</span>
<span id="cb11-92"><a href="#cb11-92"></a>                      <span class="at">tsize =</span> <span class="fu">c</span>(<span class="fu">min</span>(GBSG2<span class="sc">$</span>tsize), <span class="fu">max</span>(GBSG2<span class="sc">$</span>tsize)))</span>
<span id="cb11-93"><a href="#cb11-93"></a><span class="co"># Calculate predicted survival probabilities</span></span>
<span id="cb11-94"><a href="#cb11-94"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(cox_mod, <span class="at">newdata =</span> newdat, <span class="at">type =</span> <span class="st">"survival"</span>, <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-95"><a href="#cb11-95"></a>newdat<span class="sc">$</span>prob_surv <span class="ot">&lt;-</span> preds<span class="sc">$</span>fit</span>
<span id="cb11-96"><a href="#cb11-96"></a><span class="co"># If wanting to calculate 95% C.I.'s...</span></span>
<span id="cb11-97"><a href="#cb11-97"></a>newdat<span class="sc">$</span>lcl_surv <span class="ot">&lt;-</span> preds<span class="sc">$</span>fit <span class="sc">-</span> <span class="fl">1.96</span><span class="sc">*</span>preds<span class="sc">$</span>se.fit</span>
<span id="cb11-98"><a href="#cb11-98"></a>newdat<span class="sc">$</span>ucl_surv <span class="ot">&lt;-</span> preds<span class="sc">$</span>fit <span class="sc">+</span> <span class="fl">1.96</span><span class="sc">*</span>preds<span class="sc">$</span>se.fit</span>
<span id="cb11-99"><a href="#cb11-99"></a><span class="co"># View predictions</span></span>
<span id="cb11-100"><a href="#cb11-100"></a><span class="fu">head</span>(newdat, <span class="dv">10</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-101"><a href="#cb11-101"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb11-102"><a href="#cb11-102"></a><span class="in">```</span></span>
<span id="cb11-103"><a href="#cb11-103"></a></span>
<span id="cb11-104"><a href="#cb11-104"></a>&lt;br&gt;</span>
<span id="cb11-105"><a href="#cb11-105"></a></span>
<span id="cb11-106"><a href="#cb11-106"></a>And then we can plot the predictions like so using <span class="in">`ggplot`</span>:</span>
<span id="cb11-107"><a href="#cb11-107"></a></span>
<span id="cb11-110"><a href="#cb11-110"></a><span class="in">```{r}</span></span>
<span id="cb11-111"><a href="#cb11-111"></a><span class="co"># Create 'labeller' for tumour size</span></span>
<span id="cb11-112"><a href="#cb11-112"></a>tum_names <span class="ot">&lt;-</span> <span class="fu">as_labeller</span>(</span>
<span id="cb11-113"><a href="#cb11-113"></a>     <span class="fu">c</span>(<span class="st">`</span><span class="at">3</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Tumour Size = 3 mm"</span>, <span class="st">`</span><span class="at">120</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Tumour Size = 120 mm"</span>))</span>
<span id="cb11-114"><a href="#cb11-114"></a><span class="co"># Plot</span></span>
<span id="cb11-115"><a href="#cb11-115"></a><span class="fu">ggplot</span>(newdat, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> prob_surv, <span class="at">color =</span> horTh)) <span class="sc">+</span></span>
<span id="cb11-116"><a href="#cb11-116"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb11-117"><a href="#cb11-117"></a>  <span class="fu">facet_wrap</span>(tsize <span class="sc">~</span> ., <span class="at">labeller =</span> tum_names) <span class="sc">+</span></span>
<span id="cb11-118"><a href="#cb11-118"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb11-119"><a href="#cb11-119"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Recurrence-Free Survival (Days)"</span>,</span>
<span id="cb11-120"><a href="#cb11-120"></a>       <span class="at">y =</span> <span class="st">"Predicted Probability of Survival"</span>,</span>
<span id="cb11-121"><a href="#cb11-121"></a>       <span class="at">title =</span> <span class="st">"Probability of Survival as a Function of Hormone Therapy and Tumour Size"</span>,</span>
<span id="cb11-122"><a href="#cb11-122"></a>       <span class="at">color =</span> <span class="st">"Hormone Therapy"</span>) <span class="sc">+</span></span>
<span id="cb11-123"><a href="#cb11-123"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb11-124"><a href="#cb11-124"></a><span class="in">```</span></span>
<span id="cb11-125"><a href="#cb11-125"></a></span>
<span id="cb11-126"><a href="#cb11-126"></a>These visualisations confirm our intuition that survival is better for women with smaller tumours and who also take hormone therapy to manage their disease.</span>
<span id="cb11-127"><a href="#cb11-127"></a></span>
<span id="cb11-128"><a href="#cb11-128"></a><span class="fu"># Visualising Cox Model Predictions - Manual Mode</span></span>
<span id="cb11-129"><a href="#cb11-129"></a></span>
<span id="cb11-130"><a href="#cb11-130"></a>Ultimately, what I have described above is all you need to know if you want to visualise predictions from the Cox model. But if you are interested in understanding at a deeper level how the predicted values are calculated, I'll also take you through "manual mode".</span>
<span id="cb11-131"><a href="#cb11-131"></a></span>
<span id="cb11-132"><a href="#cb11-132"></a>An important first point to grasp is that estimation of the baseline hazard function is essential to predicting survival probabilities in time-to-event models. You can think of the baseline hazard function as the equivalent of the intercept in a standard linear model. These provide an **absolute** value of the outcome from which **relative** 'effect' estimates are computed. For example, the hazard ratio in a Cox model represents a proportional change in the hazard rate for one covariate category (e.g. hormone therapy = yes <span class="co">[</span><span class="ot">coded as 1</span><span class="co">]</span>) relative to a reference covariate category (e.g. hormone therapy = no <span class="co">[</span><span class="ot">coded as 0</span><span class="co">]</span>) which is assumed to take the shape of the baseline hazard rate function. The baseline hazard rate itself can vary over time, but the proportional change should remain the same (if the proportional hazards assumption is satisfied). I have briefly touched on these ideas in a <span class="co">[</span><span class="ot">previous post</span><span class="co">](https://msni-stats-tips.netlify.app/posts/021_01nov_2024/#semi-parametric-cox-model)</span>. The comparison with the linear model is in the regression coefficient representing a relative average change from the model intercept, which if you recall is the mean value of the outcome when all covariate values are at <span class="in">`0`</span> or at their reference level. Similarly, the baseline hazard rate function is referred to as *baseline* because it represents the hazard rate function when all covariate values are at <span class="in">`0`</span> or at their reference level.</span>
<span id="cb11-133"><a href="#cb11-133"></a></span>
<span id="cb11-134"><a href="#cb11-134"></a>Now, while fully-parametric survival models assume a particular statistical distribution for the baseline hazard rate and estimate it by default, the semi-parametric nature of the Cox model allows hazard ratios to be computed without any knowledge of the function. Consequently, we cannot directly obtain survival probabilities from it, but we can do a little post-hoc "under-the-hood" processing to combine it with a non-parametric estimator of the baseline hazard function (typically the **Breslow** estimator) - and estimate survival probabilities that way.</span>
<span id="cb11-135"><a href="#cb11-135"></a></span>
<span id="cb11-136"><a href="#cb11-136"></a>In <span class="in">`R`</span> we can use the <span class="co">[</span><span class="ot">`basehaz()`</span><span class="co">](https://stat.ethz.ch/R-manual/R-devel/library/survival/html/basehaz.html)</span> function to calculate the **cumulative** baseline hazard function <span class="in">`H(t)`</span>. This is different to the baseline hazard rate function that we have discussed until now. The cumulative baseline hazard function represents the integral of the baseline hazard rate function from <span class="in">`0`</span> to <span class="in">`t`</span>, and can be thought of as the total accumulated risk of experiencing the event of interest by time <span class="in">`t`</span>. Because it is more computationally stable to work with, <span class="in">`H(t)`</span> acts as a useful link in deriving survival probabilities from hazard rates. Once we know the cumulative baseline hazard function, it's very easy to find the commensurate survival function <span class="in">`S(t)`</span> (the probability that the event of interest has not occurred by time <span class="in">`t`</span>) by simply exponentiating the negative of <span class="in">`H(t)`</span> - i.e.:</span>
<span id="cb11-137"><a href="#cb11-137"></a></span>
<span id="cb11-138"><a href="#cb11-138"></a>$$ S(t) = e^{-H(t)} $$ More detail can be found <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.graphpad.com/guides/prism/latest/statistics/stat_cox_math_cumulative_hazard.htm)</span>.</span>
<span id="cb11-139"><a href="#cb11-139"></a></span>
<span id="cb11-140"><a href="#cb11-140"></a>Let's now put this process into action with the existing data. We can essentially break this down into five steps which I have labelled accordingly in the code below to help you follow the description:</span>
<span id="cb11-141"><a href="#cb11-141"></a></span>
<span id="cb11-142"><a href="#cb11-142"></a><span class="fu">## Step 1</span></span>
<span id="cb11-143"><a href="#cb11-143"></a>The first thing we need to do is to estimate the cumulative baseline hazard function (<span class="in">`H0`</span>) when all covariate values are at <span class="in">`0`</span> or at their reference level. We do this using specifying <span class="in">`centered = FALSE`</span> in the call to <span class="in">`basehaz()`</span>. It is important to include the <span class="in">`centered = F`</span> argument as the default setting is <span class="in">`TRUE`</span> which we don't want as this has a different interpretation (i.e. cumulative hazard function estimated at the mean of all covariate values). Also note that the cumulative hazard is estimated at each of the *observed* times in the dataset.</span>
<span id="cb11-144"><a href="#cb11-144"></a></span>
<span id="cb11-145"><a href="#cb11-145"></a><span class="fu">## Step 2</span></span>
<span id="cb11-146"><a href="#cb11-146"></a>We then estimate the cumulative hazard function (<span class="in">`H1`</span> - <span class="in">`H4`</span>) for each covariate combination of interest. For these data we have four as I have listed above. As an example, to calculate <span class="in">`H1`</span> we simply multiply <span class="in">`H0`</span> by the covariate combination values and their respective Cox model coefficients. e.g.:</span>
<span id="cb11-147"><a href="#cb11-147"></a></span>
<span id="cb11-148"><a href="#cb11-148"></a><span class="in">`H1 &lt;- H0$hazard * exp((0 * cox_mod$coefficients[1]) + (3 * cox_mod$coefficients[2]))`</span></span>
<span id="cb11-149"><a href="#cb11-149"></a></span>
<span id="cb11-150"><a href="#cb11-150"></a>In the above <span class="in">`cox_mod$coefficients[1]`</span> gives the coefficient value for hormone therapy and <span class="in">`cox_mod$coefficients[2]`</span> gives the coefficient value for tumour size. To obtain the cumulative hazard function for the first covariate combination we just multiply the cumulative baseline hazard function by the exponent of the sum of the products of the coefficients and our covariate values of interest (in this case <span class="in">`0`</span> to indicate no hormone therapy and <span class="in">`3`</span> to indicate the tumour size).</span>
<span id="cb11-151"><a href="#cb11-151"></a></span>
<span id="cb11-152"><a href="#cb11-152"></a><span class="fu">## Step 3</span></span>
<span id="cb11-153"><a href="#cb11-153"></a>We then calculate the survival function for each covariate combination by taking the exponent of the negative of the cumulative hazard function.</span>
<span id="cb11-154"><a href="#cb11-154"></a></span>
<span id="cb11-155"><a href="#cb11-155"></a><span class="fu">## Step 4</span></span>
<span id="cb11-156"><a href="#cb11-156"></a>Now we create a dataframe containing the predicted survival probabilities for each covariate combination. The first <span class="in">`20`</span> rows for each covariate combination is shown below.</span>
<span id="cb11-157"><a href="#cb11-157"></a></span>
<span id="cb11-158"><a href="#cb11-158"></a><span class="fu">## Step 5</span></span>
<span id="cb11-159"><a href="#cb11-159"></a>Then we create our plot.</span>
<span id="cb11-160"><a href="#cb11-160"></a></span>
<span id="cb11-163"><a href="#cb11-163"></a><span class="in">```{r}</span></span>
<span id="cb11-164"><a href="#cb11-164"></a><span class="co"># Step 1</span></span>
<span id="cb11-165"><a href="#cb11-165"></a><span class="co"># Estimate the cumulative baseline hazard function</span></span>
<span id="cb11-166"><a href="#cb11-166"></a>H0 <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(cox_mod, <span class="at">centered =</span> F)</span>
<span id="cb11-167"><a href="#cb11-167"></a></span>
<span id="cb11-168"><a href="#cb11-168"></a><span class="co"># Step 2</span></span>
<span id="cb11-169"><a href="#cb11-169"></a><span class="co"># Calculate cumulative hazard function for covariate combo 1.</span></span>
<span id="cb11-170"><a href="#cb11-170"></a>H1 <span class="ot">&lt;-</span> H0<span class="sc">$</span>hazard <span class="sc">*</span> <span class="fu">exp</span>((<span class="dv">0</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">1</span>]) <span class="sc">+</span> (<span class="dv">3</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">2</span>]))</span>
<span id="cb11-171"><a href="#cb11-171"></a><span class="co"># Calculate cumulative hazard function for covariate combo 2.</span></span>
<span id="cb11-172"><a href="#cb11-172"></a>H2 <span class="ot">&lt;-</span> H0<span class="sc">$</span>hazard <span class="sc">*</span> <span class="fu">exp</span>((<span class="dv">1</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">1</span>]) <span class="sc">+</span> (<span class="dv">3</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">2</span>]))</span>
<span id="cb11-173"><a href="#cb11-173"></a><span class="co"># Calculate cumulative hazard function for covariate combo 3.</span></span>
<span id="cb11-174"><a href="#cb11-174"></a>H3 <span class="ot">&lt;-</span> H0<span class="sc">$</span>hazard <span class="sc">*</span> <span class="fu">exp</span>((<span class="dv">0</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">1</span>]) <span class="sc">+</span> (<span class="dv">120</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">2</span>]))</span>
<span id="cb11-175"><a href="#cb11-175"></a><span class="co"># Calculate cumulative hazard function for covariate combo 4.</span></span>
<span id="cb11-176"><a href="#cb11-176"></a>H4 <span class="ot">&lt;-</span> H0<span class="sc">$</span>hazard <span class="sc">*</span> <span class="fu">exp</span>((<span class="dv">1</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">1</span>]) <span class="sc">+</span> (<span class="dv">120</span> <span class="sc">*</span> cox_mod<span class="sc">$</span>coefficients[<span class="dv">2</span>]))</span>
<span id="cb11-177"><a href="#cb11-177"></a></span>
<span id="cb11-178"><a href="#cb11-178"></a><span class="co"># Step 3</span></span>
<span id="cb11-179"><a href="#cb11-179"></a><span class="co"># Calculate survival function for covariate combo 1.</span></span>
<span id="cb11-180"><a href="#cb11-180"></a>S1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>H1)</span>
<span id="cb11-181"><a href="#cb11-181"></a><span class="co"># Calculate survival function for covariate combo 2.</span></span>
<span id="cb11-182"><a href="#cb11-182"></a>S2 <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>H2)</span>
<span id="cb11-183"><a href="#cb11-183"></a><span class="co"># Calculate survival function for covariate combo 3.</span></span>
<span id="cb11-184"><a href="#cb11-184"></a>S3 <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>H3)</span>
<span id="cb11-185"><a href="#cb11-185"></a><span class="co"># Calculate survival function for covariate combo 4.</span></span>
<span id="cb11-186"><a href="#cb11-186"></a>S4 <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>H4)</span>
<span id="cb11-187"><a href="#cb11-187"></a></span>
<span id="cb11-188"><a href="#cb11-188"></a><span class="co"># Step 4</span></span>
<span id="cb11-189"><a href="#cb11-189"></a><span class="co"># Create dataframe of predicted survival probabilities as a function of covariate combos</span></span>
<span id="cb11-190"><a href="#cb11-190"></a>surv_df <span class="ot">&lt;-</span>  <span class="fu">rbind</span>(<span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">1</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">0</span>, <span class="at">tsize =</span> <span class="dv">3</span>, <span class="at">prob_surv =</span> S1),</span>
<span id="cb11-191"><a href="#cb11-191"></a>                  <span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">2</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">1</span>, <span class="at">tsize =</span> <span class="dv">3</span>, <span class="at">prob_surv =</span> S2),</span>
<span id="cb11-192"><a href="#cb11-192"></a>                  <span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">3</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">0</span>, <span class="at">tsize =</span> <span class="dv">120</span>, <span class="at">prob_surv =</span> S3),</span>
<span id="cb11-193"><a href="#cb11-193"></a>                  <span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">4</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">1</span>, <span class="at">tsize =</span> <span class="dv">120</span>, <span class="at">prob_surv =</span> S4))</span>
<span id="cb11-194"><a href="#cb11-194"></a></span>
<span id="cb11-195"><a href="#cb11-195"></a><span class="co"># Inspect each df</span></span>
<span id="cb11-196"><a href="#cb11-196"></a><span class="fu">head</span>(<span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">1</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">0</span>, <span class="at">tsize =</span> <span class="dv">3</span>, <span class="at">prob_surv =</span> S1), <span class="dv">20</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-197"><a href="#cb11-197"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb11-198"><a href="#cb11-198"></a><span class="fu">head</span>(<span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">2</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">1</span>, <span class="at">tsize =</span> <span class="dv">3</span>, <span class="at">prob_surv =</span> S2), <span class="dv">20</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-199"><a href="#cb11-199"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb11-200"><a href="#cb11-200"></a><span class="fu">head</span>(<span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">3</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">0</span>, <span class="at">tsize =</span> <span class="dv">120</span>, <span class="at">prob_surv =</span> S3), <span class="dv">20</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-201"><a href="#cb11-201"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb11-202"><a href="#cb11-202"></a><span class="fu">head</span>(<span class="fu">data.frame</span>(<span class="at">combo =</span> <span class="dv">4</span>, <span class="at">time =</span> H0<span class="sc">$</span>time, <span class="at">horTh =</span> <span class="dv">1</span>, <span class="at">tsize =</span> <span class="dv">120</span>, <span class="at">prob_surv =</span> S4), <span class="dv">20</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-203"><a href="#cb11-203"></a>  <span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb11-204"><a href="#cb11-204"></a><span class="in">```</span></span>
<span id="cb11-205"><a href="#cb11-205"></a></span>
<span id="cb11-206"><a href="#cb11-206"></a>&lt;br&gt;</span>
<span id="cb11-207"><a href="#cb11-207"></a></span>
<span id="cb11-208"><a href="#cb11-208"></a>...and Voilà.</span>
<span id="cb11-209"><a href="#cb11-209"></a></span>
<span id="cb11-212"><a href="#cb11-212"></a><span class="in">```{r}</span></span>
<span id="cb11-213"><a href="#cb11-213"></a><span class="co"># Step 5</span></span>
<span id="cb11-214"><a href="#cb11-214"></a><span class="co"># Create 'labeller' for tumour size</span></span>
<span id="cb11-215"><a href="#cb11-215"></a>tum_names <span class="ot">&lt;-</span> <span class="fu">as_labeller</span>(</span>
<span id="cb11-216"><a href="#cb11-216"></a>  <span class="fu">c</span>(<span class="st">`</span><span class="at">3</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Tumour Size = 3 mm"</span>, <span class="st">`</span><span class="at">120</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Tumour Size = 120 mm"</span>))</span>
<span id="cb11-217"><a href="#cb11-217"></a><span class="co"># Plot</span></span>
<span id="cb11-218"><a href="#cb11-218"></a><span class="fu">ggplot</span>(surv_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> prob_surv, <span class="at">color =</span> <span class="fu">factor</span>(horTh))) <span class="sc">+</span></span>
<span id="cb11-219"><a href="#cb11-219"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb11-220"><a href="#cb11-220"></a>  <span class="fu">facet_wrap</span>(tsize <span class="sc">~</span> ., <span class="at">labeller =</span> tum_names) <span class="sc">+</span></span>
<span id="cb11-221"><a href="#cb11-221"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb11-222"><a href="#cb11-222"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Recurrence-Free Survival (Days)"</span>,</span>
<span id="cb11-223"><a href="#cb11-223"></a>       <span class="at">y =</span> <span class="st">"Predicted Probability of Survival"</span>,</span>
<span id="cb11-224"><a href="#cb11-224"></a>       <span class="at">title =</span> <span class="st">"Probability of Survival as a Function of Hormone Therapy and Tumour Size"</span>,</span>
<span id="cb11-225"><a href="#cb11-225"></a>       <span class="at">color =</span> <span class="st">"Hormone Therapy"</span>) <span class="sc">+</span></span>
<span id="cb11-226"><a href="#cb11-226"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb11-227"><a href="#cb11-227"></a><span class="in">```</span></span>
<span id="cb11-228"><a href="#cb11-228"></a></span>
<span id="cb11-229"><a href="#cb11-229"></a><span class="fu"># End Mode</span></span>
<span id="cb11-230"><a href="#cb11-230"></a></span>
<span id="cb11-231"><a href="#cb11-231"></a>That brings us to an end in this series on model prediction and visualisation in <span class="in">`R`</span>. I hope it's given you some appreciation for how much further you can take your regression modelling endeavours. I find being able to 'see' what my model is proposing as a reflection of reality to be an invaluable addition to the simply listing of a bunch of coefficient values that we tend to take as the final product of model estimation. We don't need to - and in fact we shouldn't - stop there. You are familiar with the statistical adage of 'always plot your data'. Well, in becoming a better data analyst I think a similar argument could be made for 'always plot your models'.</span>
<span id="cb11-232"><a href="#cb11-232"></a></span>
<span id="cb11-233"><a href="#cb11-233"></a>Until next time...</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>